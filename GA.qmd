---
title: "Genetic Algorithms in R"
subtitle: "Viá»‡t Nam, 2024"
categories: ["SupplyChainManagement", "Logistics","Genetic Algorithm"]
description: "ÄÃ¢y lÃ  bÃ i viáº¿t cá»§a tÃ´i vá» cÃ¡ch sá»­ dá»¥ng R trong á»©ng dá»¥ng Genetic Algorithm trong Supply Chain"
number-sections: true
format: 
  html:
    code-fold: true
    code-tools: true
filters:
- shinylive
bibliography: references.bib
---

# Giá»›i thiá»‡u:

```{r}
#| warning: false
#| message: false
#| echo: false
#Call packages
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               ggplot2,
               purrr,
               lubridate,
               mice,
               plotly)
```

## VÃ i Ä‘iá»ƒm vá» thuáº­t toÃ¡n Genetic:

**GA** hay **Genetic Algorithm** lÃ  1 thuáº­t toÃ¡n tá»‘i Æ°u hÃ³a ngáº«u nhiÃªn (**stochastic search algorithms**), Ä‘Æ°á»£c phÃ¡t triá»ƒn dá»±a trÃªn lÃ½ thuyáº¿t tiáº¿n hÃ³a vÃ  sá»± chá»n lá»c tá»± nhiÃªn cá»§a sinh há»c [@lucascrucca2013].

á» thá»i cáº¥p 3, báº¡n Ä‘Ã£ tá»«ng há»c vá» lÃ½ thuyáº¿t tiáº¿n hÃ³a vÃ  chá»n lá»c tá»± nhiÃªn cá»§a [Charles Darwin](https://vi.wikipedia.org/wiki/Charles_Darwin) vÃ  [Alfred Russel](https://vi.wikipedia.org/wiki/Alfred_Russel_Wallace) á»Ÿ mÃ´n Sinh há»c. Náº¿u báº¡n cÅ©ng tá»«ng liá»‡t Sinh nhÆ° tÃ´i thÃ¬ báº¡n quÃªn cÅ©ng khÃ´ng sao ğŸ˜…ğŸ˜…. Váº­y thÃ¬ Ä‘á»ƒ tÃ´i giáº£i thÃ­ch láº¡i nhÆ° sau:

Sá»± tiáº¿n hÃ³a lÃ  sá»± thay Ä‘á»•i Ä‘áº·c Ä‘iá»ƒm di truyá»n cá»§a 1 quáº§n thá»ƒ sinh váº­t, vÃ­ dá»¥ Ä‘iá»ƒn hÃ¬nh chÃ­nh lÃ  tá»« loáº¡i vÆ°á»£n Ä‘Ã£ tiáº¿n hÃ³a thÃ nh hÃ¬nh dáº¡ng con ngÆ°á»i vÄƒn minh nhÆ° cÃ¡c báº¡n bÃ¢y giá». Váº­y quÃ¡ trÃ¬nh tiáº¿n hÃ³a Ä‘Ã³ diá»…n ra khi cÃ³ sá»± chá»n lá»c tá»± nhiÃªn táº¡o ra cÃ¡c biáº¿n dá»‹ di truyá»n (VÃ­ dá»¥: Ä‘á»™t biáº¿n,...) vÃ  káº¿t quáº£ lÃ  cÃ¡c cÃ¡ thá»ƒ Ä‘á»™t biáº¿n trá»Ÿ nÃªn phá»• biáº¿n hÆ¡n hoáº·c hiáº¿m gáº·p hÆ¡n trong quáº§n thá»ƒ. Váº­y Ä‘iá»u kiá»‡n Ä‘á»ƒ xáº£y ra sá»± chá»n lá»c tá»± nhiÃªn cÃ³ thá»ƒ lÃ  sá»± thay Ä‘á»•i vá» mÃ´i trÆ°á»ng sá»‘ng, Ä‘á»‹a lÃ½,... dáº«n tá»›i sá»± khÃ¡c nhau vá» kháº£ nÄƒng sá»‘ng sÃ³t vÃ  sinh sáº£n.

Káº¿t cá»¥c lÃ  xuáº¥t hiá»‡n cÃ¡c cÃ¡ thá»ƒ Ä‘á»™t biáº¿n "máº¡nh máº½ hÆ¡n" hoáº·c Ä‘Ãºng lÃ  "Ä‘áº·c biá»‡t hÆ¡n" cÃ³ kháº£ nÄƒng tá»“n táº¡i khi xuáº¥t hiá»‡n sá»± thay Ä‘á»•i lá»›n, vÃ­ dá»¥ nhÆ° dÆ°á»›i Ä‘Ã¢y, do sá»± thay Ä‘á»•i vá» Ä‘á»‹a Ä‘iá»ƒm sá»‘ng, tá»« má»™t loáº¡i chim sáº» Ä‘Ã£ phÃ¡t triá»ƒn thÃ nh 3 phÃ¢n há» khÃ¡c nhau.

[![HÃ¬nh 1: VÃ­ dá»¥ vá» chá»n lá»c tá»± nhiÃªn](Natural_selection.jpg){fig-align="center"}](https://www.biologyonline.com/dictionary/natural-selection)

Váº­y lÃ­ thuyáº¿t nÃ y liÃªn quan gÃ¬ tá»›i váº¥n Ä‘á» tá»‘i Æ°u hÃ³a. ThÃ´ng thÆ°á»ng khi báº¡n muá»‘n tá»‘i Æ°u hÃ³a má»™t váº¥n Ä‘á» gÃ¬ Ä‘Ã³, báº¡n cáº§n xÃ¢y dá»±ng mÃ´ hÃ¬nh Ä‘á»‹nh lÆ°á»£ng nÃ³, vÃ­ dá»¥ nhÆ° dÆ°á»›i áº£nh nÃ y ta Ä‘ang cÃ³ mÃ´ hÃ¬nh [MILP](https://www.mathworks.com/help/optim/ug/mixed-integer-linear-programming-algorithms.html) nháº±m hoáº¡ch Ä‘á»‹nh tuyáº¿n Ä‘Æ°á»ng vÃ  tá»‘i Æ°u hÃ³a quÃ£ng Ä‘Æ°á»ng di chuyá»ƒn.

[![HÃ¬nh 2: MÃ´ hÃ¬nh VRP](MILP.png){fig-align="center"}](https://medium.com/@rihot_gusron/capacitated-vehicle-routing-problem-with-lingo-427c2d3bf724)

Má»¥c tiÃªu cá»§a hÃ m chÃ­nh lÃ  tÃ¬m ra giÃ¡ trá»‹ nhá» nháº¥t nghÄ©a lÃ  chi phÃ­ cho viá»‡c di chuyá»ƒn cá»§a xe lÃ  nhá» nháº¥t. Do Ä‘Ã³, báº¡n cÃ³ thá»ƒ hÃ¬nh dung ráº±ng **giÃ¡ trá»‹ nhá» nháº¥t** Ä‘Ã³ nhÆ° lÃ  cÃ¡c **cÃ¡ thá»ƒ Ä‘á»™t biáº¿n** cÃ³ kháº£ nÄƒng sá»‘ng sÃ³t cao nháº¥t trong quáº©n thá»ƒ.

VÃ¬ váº­y thuáº­t toÃ¡n **Genetic** (GA) chÃ­nh lÃ  láº·p Ä‘i láº·p láº¡i sá»± chá»n lá»c tá»± nhiÃªn trong má»™t quáº§n thá»ƒ hoáº·c má»™t máº«u Ä‘á»ƒ Ä‘áº¿n cuá»‘i cÃ¹ng tÃ¬m ra cÃ¡ thá»ƒ vÆ°á»£t trá»™i nháº¥t.

## CÃ¡ch hoáº¡t Ä‘á»™ng GA trong ML:

Trong Machine Learning, GA nháº±m tÃ¬m ra Ä‘Ãºng cÃ¡c biáº¿n cáº§n thiáº¿t Ä‘á»ƒ xÃ¢y dá»±ng mÃ´ hÃ¬nh tá»‘t nháº¥t. Gá»‰a sá»­ chÃºng ta cÃ³ 2 mÃ´ hÃ¬nh lÃ :

-   MÃ´ hÃ¬nh 1: gá»“m cÃ¡c biáº¿n A,C,D.
-   MÃ´ hÃ¬nh 2: gá»“m biáº¿n A,B,E.

Váº­y mÃ´ hÃ¬nh nÃ o má»›i lÃ  tá»‘t nháº¥t cho mÃ´ hÃ¬nh dá»± Ä‘oÃ¡n ? ChÃºng ta chÆ°a biáº¿t Ä‘Æ°á»£c vÃ  chá»‰ cÃ³ thá»ƒ so sÃ¡nh nÃ³ thÃ´ng qua thuáº­t toÃ¡n Genetic.

Vá» quy trÃ¬nh, thuáº­t toÃ¡n Genetic sáº½ cÃ³ cÃ¡ch hoáº¡t Ä‘á»™ng nhÆ° dÆ°á»›i Ä‘Ã¢y. Quy trÃ¬nh nÃ y mÃ¬nh tham kháº£o cá»§a [@rohithgandhi2018].

[![HÃ¬nh 3: Thuáº­t toÃ¡n Genetic](Genetic_Algorithm.png){fig-align="center"}](https://medium.datadriveninvestor.com/genetic-algorithms-9f920939f7cc)

Diá»…n giáº£i cÃ¡ch hoáº¡t Ä‘á»™ng:

-   BÆ°á»›c 1 (**Initialisation**): má»—i biáº¿n Ä‘Æ°á»£c xem lÃ  *Gene* vÃ  nhiá»u *Gene* gá»™p láº¡i thÃ nh má»™t mÃ´ hÃ¬nh hay gá»i lÃ  *Chromosome* vÃ  nhiá»u *Chromosome* sáº½ táº¡o thÃ nh má»™t quáº§n thá»ƒ (*Population*). Viá»‡c nÃ y giá»‘ng nhÆ° lÃ  báº¡n Ä‘ang trÃ¬nh bÃ y háº¿t cÃ¡c phÆ°Æ¡ng Ã¡n cÃ³ thá»ƒ sá»­ dá»¥ng.

[![HÃ¬nh 4: CÃ¡c thuáº­t ngá»¯ trong GA](Term.png){fig-align="center"}](https://www.doc.ic.ac.uk/research/technicalreports/2003/DTR03-4.pdf)

-   BÆ°á»›c 2 (**Fitness Function**): Báº¡n cáº§n xÃ¢y dá»±ng má»™t hÃ m má»¥c tiÃªu Ä‘á»ƒ tÃ­nh toÃ¡n giÃ¡ trá»‹ cho cÃ¡c mÃ´ hÃ¬nh á»Ÿ bÆ°á»›c 1.

-   BÆ°á»›c 3 (**Selection**): Biáº¿n nÃ o cÃ³ giÃ¡ trá»‹ yáº¿u kÃ©m sáº½ bá»‹ loáº¡i vÃ  quÃ¡ trÃ¬nh tÃ­nh toÃ¡n sáº½ tiáº¿p tá»¥c á»Ÿ tháº¿ há»‡ cá»§a nÃ³ tiáº¿p theo. Diá»…n giáº£i Ä‘Æ¡n giáº£n hÆ¡n lÃ  chÃºng ta thá»­ má»™t cÃ¡ch khÃ¡c vÃ  cá»‘ gáº¯ng cáº£i thiá»‡n káº¿t quáº£.

-   BÆ°á»›c 4 (**Crossover**): Táº¡o ra mÃ´ hÃ¬nh gá»“m cÃ¡c biáº¿n tá»‘t Ä‘Ã£ lá»±a chá»n á»Ÿ bÆ°á»›c 3. VÃ­ dá»¥ nhÆ° biáº¿n A, B lÃ  tá»‘t cho mÃ´ hÃ¬nh.

-   BÆ°á»›c 5 (**Mutation**): Thay Ä‘á»•i mÃ´ hÃ¬nh Ä‘áº§u vÃ o Ä‘Ã£ bao gá»“m cÃ¡c biáº¿n á»Ÿ bÆ°á»›c 4 vÃ  báº¯t Ä‘áº§u láº¡i tá»« bÆ°á»›c 1. VÃ­ dá»¥ mÃ´ hÃ¬nh cáº§n chá»n gá»“m 5 biáº¿n vÃ  ta Ä‘Ã£ chá»n Ä‘Æ°á»£c biáº¿n A,B lÃ  tá»‘t. Do Ä‘Ã³, khi quay láº¡i bÆ°á»›c 1, ta chá»‰ cáº§n chá»n thÃªm 3 biáº¿n thay vÃ¬ 5 biáº¿n nhÆ° thÃ´ng thÆ°á»ng.

# Thá»±c hÃ nh trong R:

Sau khi Ä‘Ã£ sÆ¡ lÆ°á»£c vá» thuáº­t toÃ¡n, bÃ¢y giá» ta sáº½ vÃ o pháº§n thá»±c hÃ nh trong R. Váº­y lÃ m sao Ä‘á»ƒ á»©ng dá»¥ng thuáº­t toÃ¡n Genetic trong R, mÃ¬nh Ä‘Ã£ kham kháº£o qua nhiá»u nguá»“n tÃ i liá»‡u vÃ  tá»•ng há»£p dÆ°á»›i Ä‘Ã¢y:

**XÃ¢y dá»±ng hÃ m má»¥c tiÃªu**: hÃ m má»¥c tiÃªu lÃ  bÆ°á»›c quan trá»ng nháº¥t trong thuáº­t toÃ¡n Genetic vÃ¬ nÃ³ lÃ  cÆ¡ sá»Ÿ Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ vÃ  lá»±a chá»n cÃ¡ thá»ƒ vÆ°á»£t trá»™i nháº¥t. VÃ  hÃ m má»¥c tiÃªu sáº½ luÃ´n khÃ¡c nhau tÃ¹y vÃ o váº¥n Ä‘á» mÃ  ta Ä‘áº·t ra. Giáº£ sá»­ chÃºng ta muá»‘n tá»‘i Æ°u chi phÃ­ thÃ¬ nÃ³ lÃ  hÃ m Min, cÃ²n ta muá»‘n tá»‘i Ä‘a lá»£i nhuáº­n thÃ¬ nÃ³ sáº½ lÃ  hÃ m Max.

Váº­y hÃ m má»¥c tiÃªu cá»§a bÃ i toÃ¡n trÃªn trong R, báº¡n cÃ³ thá»ƒ tham kháº£o pháº§n code bÃªn dÆ°á»›i mÃ¬nh:

::: callout-important
### Type of fitness function

Äá»‘i sá»‘ `type` trong hÃ m cÃ³ 3 giÃ¡ trá»‹:

-   `"binary"`: Ä‘áº¡i diá»‡n cho biáº¿n quyáº¿t Ä‘á»‹nh dáº¡ng phÃ¢n loáº¡i, vÃ­ dá»¥: cÃ³/khÃ´ng
-   `"real-valued"`: dÃ¹ng dá»ƒ tá»‘i Æ°u cho cÃ¡c biáº¿n quyáº¿t Ä‘á»‹nh lÃ  dáº¡ng sá»‘ thá»±c, sá»‘ tá»± nhiÃªn.
-   `"permutation"`: cho cÃ¡c váº¥n Ä‘á» liÃªn quan Ä‘áº¿n viá»‡c sáº¯p xáº¿p láº¡i cÃ¡c biáº¿n thÃ nh danh sÃ¡ch, vÃ­ dá»¥: thang Ä‘o Likert.
:::

Chi tiáº¿t vá» hÃ m `ga()`, báº¡n cÃ³ thá»ƒ tham kháº£o tÃ i liá»‡u cá»§a [@lucascrucca2013].

## Thuáº­t toÃ¡n Genetic:

Váº­y bÃ¢y giá» chÃºng ta sáº½ xá»­ lÃ­ bÃ i toÃ¡n trÃªn theo thuáº­t toÃ¡n **Genetic**

Gá»‰a sá»­ chÃºng ta cÃ³ bÃ i toÃ¡n vá» váº­n chuyá»ƒn hÃ ng tá»« nhÃ  kho Ä‘á»ƒ thá»a mÃ£n nhu cáº§u á»Ÿ cÃ¡c Ä‘iá»ƒm **DC (Distribution center)**. VÃ  cÃ´ng thá»©c Ä‘á»ƒ tÃ­nh toÃ¡n Ä‘Æ°á»£c chi phÃ­ lÃ :

HÃ m chi phÃ­ tá»•ng thá»ƒ Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh nhÆ° sau:

$$
TC = \sum_{i=1}^{m} \left( D_{ij} \times \frac{P}{F} \times 0.4 + LC_i \right) \times Q_j
$$

Trong bÃ i toÃ¡n nÃ y, báº¡n sáº½ cáº§n dá»¯ liá»‡u Ä‘á»ƒ tÃ­nh toÃ¡n 2 thÃ´ng sá»‘ lÃ : **PhÃ­ bá»‘c xáº¿p (Loading cost)** vÃ  **Chi phÃ­ váº­n chuyá»ƒn (Transportation cost)**.

Náº¿u trong cÃ´ng viá»‡c thÆ°á»ng ngÃ y á»Ÿ cÃ´ng ty, chÃºng ta sáº½ cáº§n láº¥y dá»¯ liá»‡u tá»« **Data warehouse** báº±ng SQL hoáº·c cÃ¡c pháº§n má»m **Business Intelligence** khÃ¡c. á» Ä‘Ã¢y, nháº±m má»¥c Ä‘Ã­ch há»c táº­p, mÃ¬nh Ä‘Ã£ táº¡o ra code á»Ÿ phÃ­a dÆ°á»›i Ä‘á»ƒ xÃ¢y dá»±ng dá»¯ liá»‡u cho cÃ¡c báº¡n luyá»‡n táº­p.

```{r}
# Create a data frame for loading costs
loading_costs <- data.frame(
  Warehouse = rep(paste("WH", 1:5), each = 4),
  ID = rep(1:5, times = 4),
  Weight_Category = rep(c("< 2 tons", "2 to 5 tons", "5 to 10 tons", "> 10 tons"), times = 5),
  Has_Machine = rep(c("Yes", "No", "Yes", "No", "No"), each = 4),
  Loading_Cost = c(80, 100, 120, 160,  # Warehouse 1 (with machine)
                   110, 150, 180, 210,  # Warehouse 2 (without machine)
                   85, 105, 125, 140,  # Warehouse 3 (with machine)
                   150, 170, 190, 210,  # Warehouse 4 (without machine)
                   140, 165, 185, 215)   # Warehouse 5 (without machine)
)

# Set seed for reproducibility
set.seed(123)

# Define parameters
weight_categories <- c("< 1.5", "1.5 to 2.5", "2.5 to 5", "5 to 10", "> 10")
# Create the data frame
loading_costs <- data.frame(
  Warehouse = rep(1:5, each = 15),  # 5 warehouses, 15 rows each
  DC = rep(rep(1:3, each = 5), times = 5),  # Repeat 1, 2, 3 for each warehouse
  Weight_Category = rep(weight_categories, times = 15),  # Repeat categories for 15 rows
  Loading_Cost = round(runif(75, 5, 150), 2),
  Has_Machine = sample(c("Yes", "No"), 75, replace = TRUE)
)

# Define warehouses with coordinates (latitude, longitude)
warehouses <- data.frame(
  ID = 1:5,
  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060), # Example latitudes (Hanoi, HCMC, Da Nang, etc.)
  Longitude = c(105.804, 108.2022, 106.6957, 108.2772, 105.7460) # Example longitudes
)

# Define distribution centers data in Vietnam (example coordinates)
distribution_centers <- data.frame(
  ID = 1:3,
  Demand = c(90, 30, 150),
  Latitude = c(17.974855, 11.7769, 15.122327), # Example latitudes (Hanoi, Da Nang, HCMC)
  Longitude = c(102.630867, 106.6957, 108.799357) # Example longitudes
)
```

Náº¿u báº¡n tá»«ng gáº·p khÃ³ khÄƒn trong viá»‡c pháº£i Ä‘á»‘i máº·t vá»›i cáº£ Ä‘á»‘ng dá»¯ liá»‡u tá»« há»‡ thá»‘ng vÃ  chÆ°a biáº¿t láº¥y dá»¯ liá»‡u nÃ o Ä‘á»ƒ phÃ¢n tÃ­ch hoáº·c gá»™p báº£ng nÃ o qua báº£ng nÃ o thÃ¬ lá»i khuyÃªn cá»§a mÃ¬nh lÃ  hÃ£y váº½ báº£ng **Entity relation diagram (ERD)**.

**ERD** lÃ  má»™t cÃ´ng cá»¥ trá»±c quan dÃ¹ng Ä‘á»ƒ mÃ´ táº£ cáº¥u trÃºc dá»¯ liá»‡u trong cÆ¡ sá»Ÿ dá»¯ liá»‡u. ERD thá»ƒ hiá»‡n cÃ¡c thá»±c thá»ƒ (*entities*), thuá»™c tÃ­nh (*attributes*), vÃ  cÃ¡c má»‘i quan há»‡ (*relationships*) giá»¯a chÃºng. CÃ¡c thá»±c thá»ƒ thÆ°á»ng Ä‘Æ°á»£c biá»ƒu diá»…n dÆ°á»›i dáº¡ng hÃ¬nh chá»¯ nháº­t, thuá»™c tÃ­nh dÆ°á»›i dáº¡ng hÃ¬nh ellips, vÃ  má»‘i quan há»‡ báº±ng hÃ¬nh thoi hoáº·c Ä‘Æ°á»ng ná»‘i. ERD giÃºp láº­p káº¿ hoáº¡ch cho thiáº¿t káº¿ cÆ¡ sá»Ÿ dá»¯ liá»‡u, Ä‘áº£m báº£o ráº±ng cÃ¡c yáº¿u tá»‘ dá»¯ liá»‡u vÃ  quan há»‡ giá»¯a chÃºng Ä‘Æ°á»£c xÃ¡c Ä‘á»‹nh rÃµ rÃ ng, táº¡o ná»n táº£ng cho viá»‡c phÃ¡t triá»ƒn vÃ  quáº£n lÃ½ dá»¯ liá»‡u hiá»‡u quáº£.

NhÆ° biá»ƒu Ä‘á»“ dÆ°á»›i Ä‘Ã¢y, mÃ¬nh Ä‘ang cÃ³ 3 báº£ng gá»“m:

- Báº£ng thÃ´ng tin chi tiáº¿t vá» DC.

- Báº£ng thÃ´ng tin chi tiáº¿t vá» WH.

- Báº£ng giÃ¡ vá» loading cost vÃ  transportation cost tá»« WH Ä‘áº¿n DC.

VÃ  cÃ¡c báº¡n cÃ³ thá»ƒ dá»… dÃ ng hÃ¬nh dung cÃ¡c má»‘i quan há»‡ thÃ´ng qua báº£ng **Entity relation diagram (ERD)** dÆ°á»›i Ä‘Ã¢y:

```{r}
#| echo: false
#| fig-subcap: "Biá»ƒu Ä‘á»“ 1: EDR model"
library(datamodelr)
# Create the data model from your data frames
dm1 <- dm_from_data_frames(list(
  Warehouses = warehouses,
  Loading_Costs = loading_costs,
  Distribution_Centers = distribution_centers
)) %>%
  dm_set_key("Warehouses", "ID") %>%
  dm_set_key("Loading_Costs", c("Warehouse", "DC")) %>%
  dm_set_key("Distribution_Centers", "ID") %>%
  dm_add_references(
    Loading_Costs$Warehouse == Warehouses$ID,  # Correct reference
    Loading_Costs$DC == Distribution_Centers$ID  # Assuming this is the correct reference
  )

# Create and render the ERD
dm_create_graph(dm1, rankdir = "LR", columnArrows = TRUE) %>%
  dm_render_graph()
```


::: callout-tip
### Táº£i package datamodelr:

MÃ¬nh táº¡o biá»ƒu Ä‘á»“ nÃ y báº±ng thÆ° viá»‡n `datamodelr`. Báº¡n cÃ³ thá»ƒ táº£i báº±ng cÃº phÃ¡p: `devtools::install_github("bergant/datamodelr")`
:::

### Dá»¯ liá»‡u Ä‘áº§u vÃ o:

NhÆ° váº­y, dá»±a vÃ o Ä‘Ã³, ta sáº½ tÃ­nh toÃ¡n Ä‘Æ°á»£c 2 *matrix* vá» chi phÃ­:

-   Báº£ng giÃ¡ loading á»Ÿ cÃ¡c kho. (HÃ¬nh bÃªn trÃ¡i)

-   Báº£ng chi phÃ­ váº­n chuyá»ƒn tá»« tá»«ng WH Ä‘áº¿n cÃ¡c DCs. (HÃ¬nh bÃªn pháº£i)

```{r}
#| warning: false
#| message: false
## Calculate the transportation cost:
# Haversine distance function
haversine <- function(lat1, lon1, lat2, lon2) {
  R <- 6371 # Radius of Earth in kilometers
  dlat <- (lat2 - lat1) * pi / 180
  dlon <- (lon2 - lon1) * pi / 180
  a <- sin(dlat / 2) * sin(dlat / 2) +
       cos(lat1 * pi / 180) * cos(lat2 * pi / 180) * 
       sin(dlon / 2) * sin(dlon / 2)
  c <- 2 * atan2(sqrt(a), sqrt(1 - a))
  R * c # Distance in kilometers
}

# Calculate distance matrix based on coordinates
distance_matrix <- matrix(0, nrow = nrow(warehouses), ncol = nrow(distribution_centers))

for (i in 1:nrow(warehouses)) {
  for (j in 1:nrow(distribution_centers)) {
    distance_matrix[i, j] <- haversine(
      warehouses$Latitude[i], warehouses$Longitude[i],
      distribution_centers$Latitude[j], distribution_centers$Longitude[j]
    )
  }
}

# Define the fuel price (example value)
fuel_price <- 20 # Fuel price per kilometer

# Calculate transportation costs
transportation_costs <- distance_matrix * fuel_price * 0.4

## Calculate the loading cost:
weights_per_good <- 0.1

mean_loading_cost<-loading_costs %>% 
  group_by(DC, Warehouse) %>% 
  summarise(mean = mean(Loading_Cost,na.rm = TRUE)/1000/weights_per_good) %>% # Assumes weighted of goods is 0.1kg 
  ungroup()

library(data.table)
# Reshape the data frame to a wide format
mean_cost_matrix <- dcast(mean_loading_cost,
                          Warehouse ~ DC, 
                          value.var = "mean")

# Convert the data frame to a matrix and remove the Warehouse column
loading_costs_per_dc <- as.matrix(mean_cost_matrix[,-1])

# Set row names as the warehouse names
rownames(loading_costs_per_dc) <- mean_loading_cost$Warehouse[!duplicated(mean_loading_cost$Warehouse)]
```

```{r}
#| warning: false
#| message: false
#| echo: false
#| layout-nrow: 2
#| fig-cap: "Biá»ƒu Ä‘á»“ 2: Heatmap cho báº£ng chi phÃ­ bá»‘c xáº¿p vÃ  báº£ng giÃ¡ váº­n chuyá»ƒn tá»« WH Ä‘áº¿n DC"
library(ggplot2)
library(reshape2)

# Convert the distance matrix to a data frame
distance_df <- melt(transportation_costs)
colnames(distance_df) <- c("Warehouse", "Distribution_Center", "Transportation Cost (VNÄ)")

# Plot the distance matrix with updated colors
ggplot(distance_df, aes(x = Distribution_Center,y = Warehouse, fill = `Transportation Cost (VNÄ)`)) +
  geom_tile() +
  geom_text(aes(label = round(`Transportation Cost (VNÄ)`, 1)), color = "black") +  # Add numbers
  scale_fill_gradient(high = "#ff7f0e", low = "white") +  # Custom colors
  theme_minimal() +
  labs(title = "Transportation Costs Heatmap",
       x = "Warehouse",
       y = "Distribution Center") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert the transportation costs matrix to a data frame
library(gt)
library(gtExtras)
# Create a gt table
m<-loading_costs %>%
  mutate(Loading_Cost = Loading_Cost * 1000,
         DC = paste("DC",DC),
         Warehouse = paste("WH",Warehouse)) # Convert to currency
  
head(m[order(-m$Loading_Cost),]) %>% 
  gt() %>%
  fmt_currency(
    columns = Loading_Cost,
    currency = "VND",
    decimals = 0,
    use_seps = TRUE
  ) %>%
  tab_header(
    title = md("**Loading Costs by weight category in each warehouses**"),
    subtitle = md("Table just contains **expected loading cost**")
  ) %>%  
  opt_align_table_header(align = "center") %>% 
  cols_label(
    Loading_Cost = "Loading Cost (VNÄ)",
    Weight_Category = "Weight Category",
    Has_Machine = "Has Machine",
    DC = "Distribution Center"
  ) %>% 
  data_color(method = "numeric",
             palette = "viridis",
             reverse = TRUE) %>% 
  gt_theme_pff() %>% 
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_body(columns = everything())) %>%
  tab_style(
    style = list(
      cell_text(align = "center")
    ),
    locations = list(
      cells_column_labels(everything())
    )
  ) %>% 
  tab_source_note(source = md("*Source: package gt in R*")) %>% 
  tab_style(
    style = "font-weight: bold",
    locations = cells_body(Weight_Category)
  )
  
```

### XÃ¢y dá»±ng hÃ m má»¥c tiÃªu:

Sau khi Ä‘Ã£ cÃ³ Ä‘á»§ dá»¯ liá»‡u, báº¡n sáº½ báº¯t Ä‘áº§u viáº¿t hÃ m má»¥c tiÃªu vÃ  dÃ¹ng thuáº­t toÃ¡n GA Ä‘á»ƒ tÃ¬m ra giÃ¡ trá»‹ tá»‘i Æ°u nháº¥t.

Trong hÃ m `ga` tá»« gÃ³i **GA** trong R, cÃ³ má»™t sá»‘ Ä‘á»‘i sá»‘ quan trá»ng cho phÃ©p báº¡n tÃ¹y chá»‰nh thuáº­t toÃ¡n di truyá»n. DÆ°á»›i Ä‘Ã¢y lÃ  má»™t cÃ¡i nhÃ¬n tá»•ng quan vá» má»™t sá»‘ Ä‘á»‘i sá»‘ quan trá»ng:

-   **type**: Chá»‰ Ä‘á»‹nh loáº¡i tá»‘i Æ°u hÃ³a (vÃ­ dá»¥: `"real-valued"`, `"binary"` hoáº·c `"permutation"`).

-   **fitness**: HÃ m Ä‘Ã¡nh giÃ¡ Ä‘á»™ phÃ¹ há»£p; nÃ³ nÃªn nháº­n má»™t vector tham sá»‘ lÃ m Ä‘áº§u vÃ o vÃ  tráº£ vá» má»™t giÃ¡ trá»‹ sá»‘.

-   **lower** vÃ  **upper**: Äá»‹nh nghÄ©a giá»›i háº¡n cho cÃ¡c biáº¿n náº¿u báº¡n Ä‘ang tá»‘i Æ°u hÃ³a trong khÃ´ng gian liÃªn tá»¥c (dÃ¹ng cho cÃ¡c loáº¡i giÃ¡ trá»‹ thá»±c).

-   **popSize**: Thiáº¿t láº­p kÃ­ch thÆ°á»›c quáº§n thá»ƒ cho má»—i tháº¿ há»‡.

-   **maxiter**: Chá»‰ Ä‘á»‹nh sá»‘ tháº¿ há»‡ tá»‘i Ä‘a Ä‘á»ƒ cháº¡y thuáº­t toÃ¡n.

-   **run**: Chá»‰ Ä‘á»‹nh sá»‘ tháº¿ há»‡ Ä‘á»ƒ cháº¡y thuáº­t toÃ¡n mÃ  khÃ´ng cÃ³ sá»± cáº£i thiá»‡n trÆ°á»›c khi dá»«ng láº¡i.

-   **pmutation**: XÃ¡c suáº¥t xáº£y ra Ä‘á»™t biáº¿n trong quáº§n thá»ƒ.

-   **elitism**: XÃ¡c Ä‘á»‹nh xem cÃ¡c cÃ¡ thá»ƒ tá»‘t nháº¥t cÃ³ nÃªn Ä‘Æ°á»£c giá»¯ láº¡i trong tháº¿ há»‡ tiáº¿p theo hay khÃ´ng.

Nhá»¯ng Ä‘á»‘i sá»‘ nÃ y giÃºp Ä‘iá»u chá»‰nh thuáº­t toÃ¡n di truyá»n cho cÃ¡c nhu cáº§u tá»‘i Æ°u hÃ³a cá»¥ thá»ƒ cá»§a báº¡n, cho phÃ©p hiá»‡u suáº¥t tá»‘t hÆ¡n vÃ  há»™i tá»¥ vá» cÃ¡c giáº£i phÃ¡p tá»‘i Æ°u.

NgoÃ i ra, cÃ²n cÃ³ cÃ¡c lÆ°u Ã½ cho báº¡n khi sá»­ dá»¥ng R nhÆ° sau:

::: callout-caution
### LÆ°u Ã½ khi dÃ¹ng hÃ m ga():

HÃ m `ga()` pháº£i cÃ³ Ã­t nháº¥t 2 Ä‘á»‘i sá»‘ lÃ  `type` vÃ  `fitness thÃ¬ R má»›i cháº¡y Ä‘Æ°á»£c.`

-   RiÃªng khi type = "binary" thÃ¬ cáº§n thÃªm Ä‘á»‘i sá»‘ `nBits.`

-   CÃ²n khi `type = "real-valued"/"permutation"` thÃ¬ cáº§n thÃªm Ä‘á»‘i sá»‘ `min` vÃ  `max`.
:::

```{r}
#| message: false
#| warning: false
#| output: false
# Load necessary library
library(GA)
demand<-c(distribution_centers$Demand)

# Define the objective function
objective_function <- function(quantities) {
    quantities_matrix <- matrix(quantities, 
                                nrow = 5, 
                                ncol = 3, 
                                byrow = TRUE)
    
    # Calculate total loading costs
    loading_costs <- rowSums(quantities_matrix) * loading_costs_per_dc  # Total loading costs for each DC
    # Calculate total transportation costs
    transportation_costs <- sum(quantities_matrix * transportation_costs)
    
    # Combine both costs
    total_cost <- sum(loading_costs) + transportation_costs
    
    # Check if demands are met
    if (any(colSums(quantities_matrix) < demand)) {
        return(Inf)  # Penalize if demands are not met
    }
    
    return(total_cost)
}

# Set up the Genetic Algorithm
num_vars <- 5 * 3  # 5 warehouses, 3 distribution centers
ga_result <- ga(
    type = "real-valued",
    fitness = function(x) -objective_function(x),  # Negate for minimization
    lower = rep(0, num_vars),  # Minimum quantity
    upper = rep(100, num_vars),  # Maximum quantity (adjust as needed)
    popSize = 50,
    maxiter = 100,
    run = 10,
    monitor = TRUE
)
```

```{r}
#| echo: false
#| warning: false
#| message: false
library(leaflet)
## Update flag of countries in each locations:
library(readxl)
write <- read_excel("write.xlsx")
warehouses<-write[1:5,]
distribution_centers<-write[6:8,]
```


```{r}
#| warning: false
#| message: false
# Assuming ga_result@solution contains optimal quantities
ga_result_solution <- c(ga_result@solution)

# Reshape the solution into a matrix (5 warehouses x 3 DCs)
optimal_quantities <- matrix(ga_result@solution,
                             nrow = 5, 
                             ncol = 3, 
                             byrow = TRUE)

# Convert the matrix to a data frame
weights<-optimal_quantities* weights_per_good

rownames(weights) <- 1:5
colnames(weights) <- 1:3

library(reshape2)
real_weighted <- melt(weights)

# Rename the columns
colnames(real_weighted) <- c("Warehouse", "DC", "Total_Weight")

# Perform left join
result <- real_weighted %>%
  left_join(loading_costs, by = c("Warehouse", "DC"))

result <-result %>% 
  mutate(Price = case_when(
    Total_Weight < 1.5 ~ "< 1.5",
    Total_Weight <2.5 ~ "1.5 to 2.5",
    Total_Weight < 5 ~ "2.5 to 5",
    Total_Weight < 10 ~ "5 to 10",
    Total_Weight >= 10 ~ "> 10",
      is.na(Total_Weight) ~ NA_character_  # Handle NA explicitly if needed
  ))
  
result<-result %>% 
  filter(Weight_Category == Price) %>% 
  select(-Price)

# Join with tranportation cost table:
rownames(transportation_costs) <- 1:5
colnames(transportation_costs) <- 1:3

transport<-melt(transportation_costs)

# Rename the columns
colnames(transport) <- c("Warehouse", "DC", "Transport_cost")


result<-left_join(result,
                  transport,
                  by=c("Warehouse", "DC"))

# Adjust:

result<-result %>% 
      mutate(Loading_Cost = Loading_Cost*1000,
             Transport_cost = Transport_cost*1000,
             DC = paste("DC",DC),
             Warehouse = paste("WH",Warehouse)) 

# Reorder cols in table:
result<-result[,c("Warehouse",
                 "DC",
                 "Has_Machine",
                 "Total_Weight",
                 "Weight_Category",
                 "Loading_Cost",
                 "Transport_cost")]
```

### BÃ¡o cÃ¡o:

VÃ  cuá»‘i cÃ¹ng, sau khi cÃ³ káº¿t quáº£, mÃ¬nh sáº½ dÃ¹ng cÃ¡c thÆ° viá»‡n gá»“m: **Leaflet**, **gt**, vÃ  **biá»ƒu Ä‘á»“ Sankey** phá»¥c vá»¥ nhá»¯ng má»¥c Ä‘Ã­ch khÃ¡c nhau cho trá»±c quan hÃ³a dá»¯ liá»‡u.

1.  **Leaflet**: ÄÃ¢y lÃ  má»™t thÆ° viá»‡n máº¡nh máº½ Ä‘á»ƒ táº¡o báº£n Ä‘á»“ tÆ°Æ¡ng tÃ¡c. NÃ³ cho phÃ©p ngÆ°á»i dÃ¹ng dá»… dÃ ng thÃªm cÃ¡c lá»›p, Ä‘iá»ƒm Ä‘Ã¡nh dáº¥u vÃ  pop-up, ráº¥t lÃ½ tÆ°á»Ÿng Ä‘á»ƒ trá»±c quan hÃ³a dá»¯ liá»‡u Ä‘á»‹a lÃ½. Leaflet Ä‘áº·c biá»‡t há»¯u Ã­ch Ä‘á»ƒ hiá»ƒn thá»‹ cÃ¡c dá»¯ liá»‡u nhÆ° vá»‹ trÃ­, lá»™ trÃ¬nh, hoáº·c phÃ¢n bá»‘ khÃ´ng gian.

2.  **gt**: GÃ³i **gt** Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ táº¡o ra cÃ¡c báº£ng cháº¥t lÆ°á»£ng cao trong R. NÃ³ cho phÃ©p ngÆ°á»i dÃ¹ng Ä‘á»‹nh dáº¡ng vÃ  táº¡o kiá»ƒu cho báº£ng má»™t cÃ¡ch dá»… dÃ ng, giÃºp chÃºng trá»Ÿ nÃªn háº¥p dáº«n vÃ  dá»… Ä‘á»c. gt há»— trá»£ cÃ¡c tÃ­nh nÄƒng nhÆ° Ä‘á»‹nh dáº¡ng tÃ¹y chá»‰nh, dÃ²ng tÃ³m táº¯t, vÃ  tháº­m chÃ­ thÃªm chÃº thÃ­ch, nÃ¢ng cao cÃ¡ch trÃ¬nh bÃ y dá»¯ liá»‡u trong bÃ¡o cÃ¡o.

3.  **Biá»ƒu Ä‘á»“ Sankey**: Nhá»¯ng biá»ƒu Ä‘á»“ nÃ y Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ trá»±c quan hÃ³a luá»“ng vÃ  má»‘i quan há»‡ giá»¯a cÃ¡c danh má»¥c khÃ¡c nhau. Trong R, gÃ³i **networkD3** hoáº·c **ggalluvial** cÃ³ thá»ƒ táº¡o ra biá»ƒu Ä‘á»“ Sankey, giÃºp hiá»ƒu cÃ¡ch cÃ¡c giÃ¡ trá»‹ di chuyá»ƒn giá»¯a cÃ¡c nÃºt, cháº³ng háº¡n nhÆ° theo dÃµi hÃ nh trÃ¬nh ngÆ°á»i dÃ¹ng hoáº·c hiá»ƒn thá»‹ phÃ¢n bá»• tÃ i nguyÃªn.

Äá»ƒ káº¿t ná»‘i cÃ¡c biá»ƒu Ä‘á»“ láº¡i vá»›i nhau, ta thÆ°á»ng nghÄ© Ä‘áº¿n `Shiny` trong **R** nhÆ°ng vÃ¬ chÃºng ta Ä‘ang táº¡o website báº±ng **Quarto** nÃªn output cuá»‘i cÃ¹ng sáº½ lÃ  má»™t trang web tÄ©nh - *static website*. Do Ä‘Ã³, nÃ³ sáº½ khÃ´ng pháº£n há»“i vá»›i thÃ´ng tin Ä‘áº§u vÃ o cá»§a ngÆ°á»i dÃ¹ng hoáº·c cháº¡y báº¥t ká»³ mÃ£ R nÃ o. Báº¡n cÃ³ thá»ƒ hÃ¬nh dung giá»‘ng nhÆ° báº¡n Ä‘ang muá»‘n xem biá»ƒu Ä‘á»“ vá» doanh thu trong thÃ¡ng tiáº¿p theo trÃªn 1 biá»ƒu Ä‘á»“ trong Word - khÃ´ng thá»ƒ lÃ m Ä‘Æ°á»£c vÃ¬ nÃ³ thuá»™c dáº¡ng vÄƒn báº£n, báº¡n chá»‰ Ä‘á»c hoáº·c nhÃ¬n chá»© khÃ´ng tÆ°Æ¡ng tÃ¡c Ä‘Æ°á»£c.

Tuy váº­y, sau má»™t thá»i gian tÃ¬m hiá»ƒu, mÃ¬nh cÅ©ng tÃ¬m Ä‘Æ°á»£c cÃ¡ch Ä‘á»ƒ nhÃºng **Shiny** vÃ o R Ä‘á»ƒ hiá»ƒn thá»‹ trÃªn Quarto. Nguá»“n tÃ i liá»‡u báº¡n cÃ³ thá»ƒ kham kháº£o á»Ÿ trang nÃ y [r-shinylive-demo](https://github.com/coatless-quarto/r-shinylive-demo).

```{shinylive-r}
#| viewerHeight: 500
#| standalone: true
#| fig-cap: "Biá»ƒu Ä‘á»“ 3: Dashboard vá» lá»‹ch trÃ¬nh váº­n chuyá»ƒn hÃ ng dá»± tÃ­nh"
# Load required libraries
pacman::p_load(leaflet, 
               dplyr, 
               networkD3,
               shiny)

# Add value:
# Convert GA solution to a matrix
# Optimal quantities matrix
optimal_quantities <- matrix(c(
  43.306058, 10.87137, 13.26283,
  15.524054, 30.42748, 48.86716,
  7.599769, 44.93531, 27.46289,
  18.556927, 17.60396, 41.85203,
  16.305016, 13.15498, 21.79634
), nrow = 5, ncol = 3, byrow = TRUE)


# Warehouse data:
warehouses <- data.frame(
  ID = 1:5,
  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060),
  Longitude = c(105.8040, 108.2022, 106.6957, 108.2772, 105.7460),
  District = c("Äá»‘ng Äa", "Háº£i ChÃ¢u", "Quáº­n 1", "Mang Yang", "ÄÃ´ng SÆ¡n"),
  Province = c("HÃ  Ná»™i", "ÄÃ  Náºµng", "Há»“ ChÃ­ Minh", "Gia Lai", "Thanh HÃ³a"),
  Address = c(
    "2RH3+9HX Äá»‘ng Äa, HÃ  Ná»™i, Viá»‡t Nam",
    "3632+RV4 Háº£i ChÃ¢u, ÄÃ  Náºµng, Viá»‡t Nam",
    "QMGW+Q74 Quáº­n 1, Há»“ ChÃ­ Minh, Viá»‡t Nam",
    "375G+8VG Mang Yang, Gia Lai, Viá»‡t Nam",
    "RP4W+99X ÄÃ´ng SÆ¡n, Thanh HÃ³a, Viá»‡t Nam"
  )
)

# Distribution center data:
distribution_centers <- data.frame(
  ID = 1:3,
  Latitude = c(17.97486, 11.77690, 15.12233),
  Longitude = c(102.6309, 106.6957, 108.7994),
  District = c("ViÃªng ChÄƒn", "Lá»™c Ninh", "Quáº£ng NgÃ£i"),
  Province = c("LÃ o", "BÃ¬nh PhÆ°á»›c", "Quáº£ng NgÃ£i"),
  Address = c(
    "XJFJ+W8X ViÃªng ChÄƒn, LÃ o",
    "QMGW+Q74 Lá»™c Ninh, BÃ¬nh PhÆ°á»›c, Viá»‡t Nam",
    "4QCX+WPQ Quáº£ng NgÃ£i, Viá»‡t Nam"
  )
)

# Create a data frame with the warehouse data
result <- data.frame(
  Warehouse = c("WH 1", "WH 2", "WH 3", "WH 4", "WH 5",
                "WH 1", "WH 2", "WH 3", "WH 4", "WH 5",
                "WH 1", "WH 2", "WH 3", "WH 4", "WH 5"),
  DC = c("DC 1", "DC 1", "DC 1", "DC 1", "DC 1",
         "DC 2", "DC 2", "DC 2", "DC 2", "DC 2",
         "DC 3", "DC 3", "DC 3", "DC 3", "DC 3"),
  Has_Machine = c("Yes", "No", "No", "No", "No",
                  "No", "No", "No", "No", "No",
                  "No", "No", "No", "No", "No"),
  Total_Weight = c(4.3306058, 1.5524054, 0.7599769, 1.8556927, 1.6305016,
                   1.0871366, 3.0427479, 4.4935308, 1.7603961, 1.3154977,
                   1.3262832, 4.8867159, 2.7462887, 4.1852028, 2.1796338),
  Weight_Category = c("2.5 to 5", "1.5 to 2.5", "< 1.5", "1.5 to 2.5", "1.5 to 2.5",
                      "< 1.5", "2.5 to 5", "2.5 to 5", "1.5 to 2.5", "< 1.5",
                      "< 1.5", "2.5 to 5", "2.5 to 5", "2.5 to 5", "1.5 to 2.5"),
  Loading_Cost = c(64300, 40680, 144640, 38790, 18750,
                   11610, 97870, 36380, 69120, 70030,
                   143740, 91150, 64990, 114230, 96240),
  Transport_cost = c(3802097.2, 5037171.3, 7297102.2, 5952559.7, 3086494.5,
                     8264855.3, 4021256.9, 889559.4, 2449208.3, 7188382.3,
                     5831987.6, 974375.3, 4273915.6, 1047828.2, 4905804.6)
)

# Custom icon:
warehouse_icon <- makeIcon(
      iconUrl = "https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/warehouse_icon.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )

dc_icon <- makeIcon(
      iconUrl = "https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/distribution_center.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )


# Define UI
ui <- fluidPage(
  titlePanel("Warehouse Distribution Dashboard"),
  
  sidebarLayout(
    sidebarPanel(
      helpText("Select one or more warehouses to view distribution data."),
      checkboxGroupInput(inputId = "warehouse", 
                         label = "Select Warehouse:", 
                         choices = paste("Warehouse", 1:5), 
                         selected = paste("Warehouse", 1))
    ), 
    mainPanel(
      tabsetPanel(
        tabPanel("Map", 
                 leafletOutput("map", height = "400px")),
        tabPanel("Data Table",
                 fluidRow(
                   column(12, div(style = "height: 400px;", dataTableOutput("cost_table")))
                 )),
        tabPanel("Sankey Chart",
                 fluidRow(
                   column(12, div(style = "height: 400px;", uiOutput("sankey_ui")))
                 ))
      )
    )
  )
)


# Define server logic
server <- function(input, output, session) {
  
  location <- reactive({
    req(input$warehouse) 
    as.numeric(sub("Warehouse ", "", input$warehouse))
  })
  
  # Create the leaflet map
  output$map <- renderLeaflet({
    req(location())
    
    # Initialize the map
    map <- leaflet() %>%
      addTiles() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addMarkers(data = warehouses %>% filter(ID %in% location()), 
                 lat = ~Latitude, 
                 lng = ~Longitude, 
                 label = ~paste0("<strong> ID Warehouse: </strong> ", ID, "<br/> ",
                                 "<strong> Province: </strong> ", Province, "<br/> ",
                                 "<strong> District: </strong> ", District, "<br/> ",
                                 "<strong> Address: </strong> ", Address, "<br/> ") %>% 
                   lapply(htmltools::HTML),
                 icon = warehouse_icon) %>%
      addMarkers(data = distribution_centers, 
                 lat = ~Latitude, 
                 lng = ~Longitude, 
                 label = ~paste0("<strong> ID Distribution Center: </strong> ", ID, "<br/> ",
                                 "<strong> Province: </strong> ", Province, "<br/> ",
                                 "<strong> District: </strong> ", District, "<br/> ",
                                 "<strong> Address: </strong> ", Address, "<br/> ") %>% 
                   lapply(htmltools::HTML),
                 icon = dc_icon)
    
    qty_data <- optimal_quantities[location(), , drop = FALSE]  
    
    # Add routes based on the optimal quantities
    for (i in 1:nrow(qty_data)) {
      for (j in 1:ncol(qty_data)) {
        if (qty_data[i, j] > 0) {
          route_start <- warehouses[warehouses$ID == i, c("Longitude", "Latitude")]
          route_end <- distribution_centers[distribution_centers$ID == j, c("Longitude", "Latitude")]
          
          map <- map %>%
            addPolylines(lat = c(route_start$Latitude, route_end$Latitude),
                         lng = c(route_start$Longitude, route_end$Longitude),
                         color = "black", weight = 2, opacity = 0.5)
        }
      }
    }
    
    map  # Return the modified map
  })
  
  # Render the cost table
  output$cost_table <- renderDataTable({
    req(location())
    
    gt <- result %>% 
      filter(Warehouse %in% paste("WH", location())) %>% 
      select(c(Warehouse, 
               DC, 
               Loading_Cost, 
               Transport_cost))
    
    gt
  })
  
  # Render the Sankey diagram
  output$sankey_ui <- renderUI({
    req(location())
    
    qty_data <- optimal_quantities[location(), , drop = FALSE] 
    req(nrow(qty_data) > 0)  # Ensure there is data to display
    
    # Create links data frame
    links <- data.frame(
      source = rep(0:(nrow(qty_data) - 1), each = ncol(qty_data)),  
      target = as.vector(sapply(0:(ncol(qty_data) - 1), 
                                function(j) rep(nrow(qty_data) + j, nrow(qty_data)))),
      value = as.vector(qty_data)  
    )
    
    # Filter for selected warehouses
    links <- links %>% filter(source %in% (location() - 1))  
    
    # Create nodes data frame
    nodes <- data.frame(name = c(paste("Warehouse", location()), paste("DC", 1:ncol(qty_data))))
    
    # Create the Sankey network
    sankey <- sankeyNetwork(Links = links, 
                            Nodes = nodes, 
                            Source = "source", 
                            Target = "target", 
                            Value = "value",
                            NodeID = "name",
                        height = 500,  
                        width = 400,
                        fontSize = 12,
                        nodeWidth = 20,
                        sinksRight = FALSE) # Change this value to make it thinner
    
    # Customize tooltips and add click functionality to show a value panel
sankey <- htmlwidgets::onRender(sankey, "
  function(el, x) {
    // Create a div for the value panel
    var valuePanel = d3.select('body').append('div')
      .attr('class', 'value-panel')
      .style('position', 'absolute')
      .style('padding', '8px')
      .style('background', 'lightgray')
      .style('border', '1px solid gray')
      .style('border-radius', '4px')
      .style('opacity', 0);  // Start hidden

    // Append title for tooltips on hover
    d3.selectAll('.link')
      .append('title')
      .text(function(d) { return d.value; });  // Show value on hover

    // Add click event to show the value panel
    d3.selectAll('.link')
      .on('click', function(event, d) {
        // Ensure we get the correct value
        var value = d3.select(this).datum().value;

        // Position the value panel near the mouse cursor
        valuePanel
          .style('left', (event.pageX + 5) + 'px')
          .style('top', (event.pageY + 5) + 'px')
          .style('opacity', 1)  // Make it visible
          .html('Value: ' + value);  // Set the text to the link value

        // Hide the panel after a delay
        setTimeout(function() {
          valuePanel.style('opacity', 0);
        }, 2000);  // Change the delay as needed
      });
  }
")
    
    ## Add title and caption:
sankey <- htmlwidgets::appendContent(sankey, htmltools::tags$p(style = "font-size: 12px; text-align: right;", " A wider arrow indicates that a larger quantity is being sent from that warehouse to a distribution center."))
    sankey  # Output the Sankey diagram
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

Báº¡n cÃ³ thá»ƒ tháº¥y vá»›i **dashboard** nhÆ° váº­y, ta cÃ³ thá»ƒ xem Ä‘Æ°á»£c nhiá»u thÃ´ng tin hÆ¡n nhÆ°:

- Vá»‹ trÃ­ cá»¥ thá»ƒ cá»§a tá»«ng *WH* vÃ  *DC* cÅ©ng nhÆ° lÃ  cÃ¡c tuyáº¿n Ä‘Æ°á»ng dá»± kiáº¿n báº±ng cÃ¡c Ä‘Æ°á»ng tháº³ng minh há»a. (Xem **Map tab**)

- ThÃ´ng tin vá» chi phÃ­ *Loading cost* vÃ  *Transporation cost* cÅ©ng nhÆ° lÆ°á»£ng hÃ ng cáº§n váº­n chuyá»ƒn cho tá»«ng nhÃ  kho. (Xem **Table and Sankey tab**)

Báº¡n cÃ³ thá»ƒ xem cho 1 hoáº·c nhiá»u nhÃ  kho báº±ng cÃ¡ch *click* trÃªn thanh **Filter**. NgoÃ i ra, Ä‘áº·c biá»‡t vá»›i **Sankey chart**, báº¡n cáº§n giá»¯ hoáº·c *click* chuá»™t vÃ o tuyáº¿n Ä‘á»ƒ xem Ä‘Æ°á»£c sá»‘ lÆ°á»£ng hÃ ng.

Tuy ráº¥t thÃ­ch R nhÆ°ng mÃ¬nh váº«n khÃ´ng thÃ­ch xÃ¢y dá»±ng dashboard báº±ng R láº¯m vÃ¬ quÃ¡ náº·ng vá» code vÃ  khÃ´ng hiá»‡u quáº£ vá» thá»i gian, nguá»“n lá»±c. CÃ¡c tools khÃ¡c mÃ¬nh Æ°u tiÃªn hÆ¡n nhÆ° **Power BI**, **Tableau** hoáº·c cÃ¡c **BIs** mÃ  cÃ´ng ty báº¡n sá»­ dá»¥ng trong cÃ´ng viá»‡c háº±ng ngÃ y.

## MÃ´ hÃ¬nh MILP:

Tiáº¿p theo ta sáº½ chuyá»ƒn sang thuáº­t toÃ¡n tuyáº¿n tÃ­nh má»›i lÃ  mÃ´ hÃ¬nh MILP.

### Giá»›i thiá»‡u sÆ¡ lÆ°á»£c:

**MILP (Mixed Integer Linear Programming)** lÃ  má»™t phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c bÃ i toÃ¡n láº­p káº¿ hoáº¡ch, phÃ¢n bá»• tÃ i nguyÃªn, vÃ  quyáº¿t Ä‘á»‹nh trong cÃ¡c lÄ©nh vá»±c nhÆ° logistics, sáº£n xuáº¥t, tÃ i chÃ­nh, vÃ  nhiá»u lÄ©nh vá»±c khÃ¡c. MILP lÃ  má»™t pháº§n má»Ÿ rá»™ng cá»§a láº­p trÃ¬nh tuyáº¿n tÃ­nh (Linear Programming - LP), trong Ä‘Ã³ cÃ³ cÃ¡c biáº¿n lÃ  sá»‘ nguyÃªn (integer variables) bÃªn cáº¡nh cÃ¡c biáº¿n liÃªn tá»¥c (continuous variables).

Trong Ä‘Ã³, cáº¥u trÃºc cá»§a má»™t bÃ i toÃ¡n MILP bao gá»“m:

1.  **HÃ m má»¥c tiÃªu**: LÃ  má»™t hÃ m tuyáº¿n tÃ­nh mÃ  báº¡n muá»‘n tá»‘i Æ°u hÃ³a (tá»‘i Ä‘a hÃ³a hoáº·c tá»‘i thiá»ƒu hÃ³a).

    $$
    \text{Maximize or Minimize } Z = c_1x_1 + c_2x_2 + \ldots + c_nx_n
    $$

2.  **RÃ ng buá»™c**: Bao gá»“m cÃ¡c Ä‘iá»u kiá»‡n tuyáº¿n tÃ­nh mÃ  cÃ¡c biáº¿n pháº£i thá»a mÃ£n.

    $$
    a_{11}x_1 + a_{12}x_2 + \ldots + a_{1n}x_n \leq b_1
    $$

    $$
    a_{21}x_1 + a_{22}x_2 + \ldots + a_{2n}x_n \leq b_2
    $$

    ... vÃ  nhiá»u rÃ ng buá»™c khÃ¡c.

3.  **Biáº¿n quyáº¿t Ä‘á»‹nh**: CÃ¡c biáº¿n trong bÃ i toÃ¡n cÃ³ thá»ƒ lÃ :

    -   Biáº¿n liÃªn tá»¥c: CÃ³ thá»ƒ nháº­n má»i giÃ¡ trá»‹ thá»±c (vÃ­ dá»¥: sá»‘ lÆ°á»£ng sáº£n pháº©m).
    -   Biáº¿n nguyÃªn: Chá»‰ nháº­n giÃ¡ trá»‹ nguyÃªn (vÃ­ dá»¥: sá»‘ lÆ°á»£ng xe táº£i).
    -   Biáº¿n nhá»‹ phÃ¢n: Chá»‰ nháº­n giÃ¡ trá»‹ 0 hoáº·c 1 (vÃ­ dá»¥: cÃ³ hoáº·c khÃ´ng sá»­ dá»¥ng má»™t nhÃ  mÃ¡y).

MÃ´ hÃ¬nh **MILP** lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ cho viá»‡c tá»‘i Æ°u hÃ³a trong nhiá»u lÄ©nh vá»±c khÃ¡c nhau. Vá»›i kháº£ nÄƒng káº¿t há»£p giá»¯a cÃ¡c biáº¿n liÃªn tá»¥c vÃ  sá»‘ nguyÃªn, MILP cÃ³ thá»ƒ giáº£i quyáº¿t nhiá»u bÃ i toÃ¡n phá»©c táº¡p mÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a khÃ¡c khÃ´ng thá»ƒ thá»±c hiá»‡n hiá»‡u quáº£.
CÃ¡c á»©ng dá»¥ng phá»• biáº¿n bao gá»“m:

-   **Quáº£n lÃ½ chuá»—i cung á»©ng**: Tá»‘i Æ°u hÃ³a viá»‡c phÃ¢n phá»‘i hÃ ng hÃ³a tá»« cÃ¡c kho Ä‘áº¿n cÃ¡c khÃ¡ch hÃ ng.
-   **Láº­p káº¿ hoáº¡ch sáº£n xuáº¥t**: XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng sáº£n pháº©m cáº§n sáº£n xuáº¥t Ä‘á»ƒ tá»‘i Ä‘a hÃ³a lá»£i nhuáº­n hoáº·c giáº£m chi phÃ­.
-   **Tá»‘i Æ°u hÃ³a lá»‹ch trÃ¬nh**: Láº­p lá»‹ch cho nhÃ¢n viÃªn, mÃ¡y mÃ³c, hoáº·c tÃ i nguyÃªn Ä‘á»ƒ tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t.
-   **Quy hoáº¡ch Ä‘Ã´ thá»‹**: Tá»‘i Æ°u hÃ³a viá»‡c sá»­ dá»¥ng Ä‘áº¥t vÃ  tÃ i nguyÃªn trong quy hoáº¡ch thÃ nh phá»‘.

Trong R cÃ³ cÃ¡c thÆ° viá»‡n nhÆ° `lpSolve`, `ompr`, vÃ  `ROI` cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c bÃ i toÃ¡n MILP.

### VÃ­ dá»¥ vá» mÃ´ hÃ¬nh MILP: 

Gá»‰a sá»­ ta cÃ³ bÃ i toÃ¡n vá» váº¥n Ä‘á» **Transshipment** cÃ³ yÃªu cáº§u lÃ  tÃ¬m ra phÆ°Æ¡ng Ã¡n váº­n táº£i tá»‘i Æ°u nháº¥t Ä‘á»ƒ váº­n chuyá»ƒn hÃ ng hÃ³a tá»« nhÃ  mÃ¡y (**Factory**) thÃ´ng qua **Crossdocking** vÃ  Ä‘áº¿n Ä‘Æ°á»£c **Distribution Center** vá»›i má»¥c tiÃªu lÃ  Ä‘áº¡t **chi phÃ­ tháº¥p nháº¥t**.

![HÃ¬nh 5: Váº¥n Ä‘á» Transshipment](transshipment.png){fig-align="center"}

VÃ¬ bÃ i toÃ¡n nÃ y thuá»™c dáº¡ng tuyáº¿n tÃ­nh, phÆ°Æ¡ng phÃ¡p MILP sáº½ lÃ m tá»‘t hÆ¡n nhiá»u so vá»›i thuáº­t toÃ¡n GA bÃªn trÃªn.

```{r}
#| warning: false
#| message: false
#| output: false

library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)
#Input:
Supply <-c(200,300,100,150,220)
Demand <-c(150,100,110,200,180)
DC<-2
m<-length(Supply)
n<-length(Demand)

Cost_CD<-read.table(text = 
                    "CD1 CD2
                     30 50
                     23 66
                     35 14
                     70 12
                     65 70",header = T)
Cost_DC<-read.table(text = 
                      "DC1 DC2 DC3 DC4 DC5
                       12 25 22 40 41
                       65 22 23 12 15",header = T)

#MILP model from the 
model5 <- MIPModel() %>%
  # Add variable
  add_variable(x[i, j], i = 1:m, j = 1:DC) %>%
  add_variable(y[j, k], j = 1:DC, k = 1:n) %>%
  # minimize the cost of transshipment:
  set_objective(sum_expr(x[i, j]*Cost_CD[i, j],i = 1:m, j = 1:DC)+ sum_expr(y[j, k]*Cost_DC[j, k], k = 1:n, j = 1:DC),"min") %>%
  add_constraint(sum_expr(y[j, k], j = 1:DC) >= Demand[k], k = 1:n) %>%
  # The amount of inventory in Crossdocking is smaller than production goods
  add_constraint(sum_expr(x[i, j], j = 1:DC) <= Supply[i], i = 1:m) %>% 
  # The amount of is bigger than demand in DC
  add_constraint(sum_expr(x[i, j], i = 1:m) - sum_expr(y[j, k], k = 1:n) >= 0,j = 1:DC) %>%
  add_constraint(x[i, j] >= 0, j = 1:DC, i = 1:m)%>% 
  add_constraint(y[j, k] >= 0, j = 1:DC, k = 1:n)%>% 
  #Solve the model:
  solve_model(with_ROI(solver = "glpk", verbose = TRUE))
```

```{r}
#| layout: [[50,50]]
#| warning: false
#| message: false
#| echo: false

## Table:
solution <- get_solution(model5, x[i, j]) %>% 
     filter(value > 0)

library(gt)
library(dplyr)
library(scales)  

# Assuming `solution` contains the results of x[i, j]
# Transform the solution into a tidy format for the table
table_data <- solution %>%
  rename(Manufacturer = i, DC = j, Flow = value) %>%
  mutate(Manufacturer = paste("Manufacturer", Manufacturer),
         DC = paste("DC", DC)) %>% 
  select(-variable)

# Create a gt table
table_data %>%
  gt() %>%
  tab_header(
    title = md("**Transshipment flows from Manufacturers to Distribution Centers**")
  ) %>%
  cols_label(
    Manufacturer = md("**Manufacturer**"),
    DC = md("**Distribution Center**"),
    Flow = md("**Flow Amount**")) %>%
  fmt_number(
    columns = c(Flow),
    decimals = 2
  ) %>%
  data_color(
    columns = c(Flow),  # Use c() instead of vars()
    colors = scales::col_numeric(palette = c("#2ca02c","#ff7f0e"), domain = NULL)
  ) %>%
  cols_align(
    align = "center",
    columns = everything()  # Applies to all columns
  ) %>%
  tab_options(
    table.width = pct(100)
  ) %>% 
  gt_theme_espn()

## Barchart:

library(ggplot2)
plot_data <- solution %>%
  rename(Manufacter= i, DC = j, Flow = value) %>%
  mutate(Manufacter = paste("Manufacter", Manufacter),
         DC = paste("DC", DC))

# Create a plot
ggplot(plot_data, aes(x = Manufacter, y = Flow, fill = DC)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "",
       x = "Manufacters",
       y = "Flow Amount",
       fill = "Distribution Centers") +
  theme(text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")
```


NhÆ° váº­y, chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c há»c vá» thuáº­t toÃ¡n Genetic vÃ  mÃ´ hÃ¬nh MILP cÅ©ng nhÆ° cÃ¡ch thá»±c hiá»‡n trong Rstudio. 

Náº¿u báº¡n cÃ³ cÃ¢u há»i hay tháº¯c máº¯c nÃ o, Ä‘á»«ng ngáº§n ngáº¡i liÃªn há»‡ vá»›i mÃ¬nh qua Gmail. BÃªn cáº¡nh Ä‘Ã³, náº¿u báº¡n muá»‘n xem láº¡i cÃ¡c bÃ i viáº¿t trÆ°á»›c Ä‘Ã¢y cá»§a mÃ¬nh, hÃ£y nháº¥n vÃ o hai nÃºt dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ truy cáº­p trang **Rpubs** hoáº·c mÃ£ nguá»“n trÃªn **Github**. Ráº¥t vui Ä‘Æ°á»£c Ä‘á»“ng hÃ nh cÃ¹ng báº¡n, háº¹n gáº·p láº¡i! ğŸ˜„ğŸ˜„ğŸ˜„


```{=html}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Me</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; }
        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        label { display: block; margin: 10px 0 5px; }
        input[type="email"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }
        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }
        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }
        .rpubs-button button { background-color: #75AADB; }
        .rpubs-button button:hover { background-color: #5A9BC2; }
        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Contact Me</h2>
        <form id="emailForm">
            <label for="email">Your Email:</label>
            <input type="email" id="email" name="email" required aria-label="Email Address">
            <div class="error-message" id="error-message" style="display: none;">Please enter a valid email address.</div>
            <button type="submit">Send Email</button>
        </form>
        <div class="github-button">
            <button>
                <a href="https://github.com/Loccx78vn" target="_blank" style="color: white; text-decoration: none;">
                    <i class="fab fa-github"></i> View Code on GitHub
                </a>
            </button>
        </div>
        <div class="rpubs-button">
            <button>
                <a href="https://rpubs.com/loccx" target="_blank" style="color: white; text-decoration: none;">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg" alt="RStudio icon" class="rpubs-icon"> Visit my RPubs
                </a>
            </button>
        </div>
    </div>

    <script>
        document.getElementById('emailForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            const emailInput = document.getElementById('email');
            const email = emailInput.value;
            const errorMessage = document.getElementById('error-message');

            // Simple email validation regex
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailPattern.test(email)) {
                errorMessage.style.display = 'none'; // Hide error message
                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;
                window.open(gmailLink, '_blank'); // Open in new tab
            } else {
                errorMessage.style.display = 'block'; // Show error message
            }
        });
    </script>
</body>
</html>
```
