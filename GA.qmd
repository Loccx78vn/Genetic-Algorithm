---
title: "Genetic Algorithms in R"
subtitle: "Vi·ªát Nam, 2024"
categories: ["SupplyChainManagement", "Logistics","Genetic Algorithm"]
description: "ƒê√¢y l√† b√†i vi·∫øt c·ªßa t√¥i v·ªÅ c√°ch s·ª≠ d·ª•ng R trong ·ª©ng d·ª•ng Genetic Algorithm trong Supply Chain"
number-sections: true
format: 
  html:
    code-fold: true
    code-tools: true
bibliography: references.bib
---

# Gi·ªõi thi·ªáu:

```{r}
#| warning: false
#| message: false
#| echo: false
#Call packages
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               ggplot2,
               purrr,
               lubridate,
               mice,
               plotly)
```

## V√†i ƒëi·ªÉm v·ªÅ thu·∫≠t to√°n Genetic:

**GA** hay **Genetic Algorithm** l√† 1 thu·∫≠t to√°n t·ªëi ∆∞u h√≥a ng·∫´u nhi√™n (**stochastic search algorithms**), ƒë∆∞·ª£c ph√°t tri·ªÉn d·ª±a tr√™n l√Ω thuy·∫øt ti·∫øn h√≥a v√† s·ª± ch·ªçn l·ªçc t·ª± nhi√™n c·ªßa sinh h·ªçc [@lucascrucca2013].

·ªû th·ªùi c·∫•p 3, b·∫°n ƒë√£ t·ª´ng h·ªçc v·ªÅ l√Ω thuy·∫øt ti·∫øn h√≥a v√† ch·ªçn l·ªçc t·ª± nhi√™n c·ªßa [Charles Darwin](https://vi.wikipedia.org/wiki/Charles_Darwin) v√† [Alfred Russel](https://vi.wikipedia.org/wiki/Alfred_Russel_Wallace) ·ªü m√¥n Sinh h·ªçc. N·∫øu b·∫°n c≈©ng t·ª´ng li·ªát Sinh nh∆∞ t√¥i th√¨ b·∫°n qu√™n c≈©ng kh√¥ng sao üòÖüòÖ. V·∫≠y th√¨ ƒë·ªÉ t√¥i gi·∫£i th√≠ch l·∫°i nh∆∞ sau:

S·ª± ti·∫øn h√≥a l√† s·ª± thay ƒë·ªïi ƒë·∫∑c ƒëi·ªÉm di truy·ªÅn c·ªßa 1 qu·∫ßn th·ªÉ sinh v·∫≠t, v√≠ d·ª• ƒëi·ªÉn h√¨nh ch√≠nh l√† t·ª´ lo·∫°i v∆∞·ª£n ƒë√£ ti·∫øn h√≥a th√†nh h√¨nh d·∫°ng con ng∆∞·ªùi vƒÉn minh nh∆∞ c√°c b·∫°n b√¢y gi·ªù. V·∫≠y qu√° tr√¨nh ti·∫øn h√≥a ƒë√≥ di·ªÖn ra khi c√≥ s·ª± ch·ªçn l·ªçc t·ª± nhi√™n t·∫°o ra c√°c bi·∫øn d·ªã di truy·ªÅn (V√≠ d·ª•: ƒë·ªôt bi·∫øn,...) v√† k·∫øt qu·∫£ l√† c√°c c√° th·ªÉ ƒë·ªôt bi·∫øn tr·ªü n√™n ph·ªï bi·∫øn h∆°n ho·∫∑c hi·∫øm g·∫∑p h∆°n trong qu·∫ßn th·ªÉ. V·∫≠y ƒëi·ªÅu ki·ªán ƒë·ªÉ x·∫£y ra s·ª± ch·ªçn l·ªçc t·ª± nhi√™n c√≥ th·ªÉ l√† s·ª± thay ƒë·ªïi v·ªÅ m√¥i tr∆∞·ªùng s·ªëng, ƒë·ªãa l√Ω,... d·∫´n t·ªõi s·ª± kh√°c nhau v·ªÅ kh·∫£ nƒÉng s·ªëng s√≥t v√† sinh s·∫£n.

K·∫øt c·ª•c l√† xu·∫•t hi·ªán c√°c c√° th·ªÉ ƒë·ªôt bi·∫øn "m·∫°nh m·∫Ω h∆°n" ho·∫∑c ƒë√∫ng l√† "ƒë·∫∑c bi·ªát h∆°n" c√≥ kh·∫£ nƒÉng t·ªìn t·∫°i khi xu·∫•t hi·ªán s·ª± thay ƒë·ªïi l·ªõn, v√≠ d·ª• nh∆∞ d∆∞·ªõi ƒë√¢y, do s·ª± thay ƒë·ªïi v·ªÅ ƒë·ªãa ƒëi·ªÉm s·ªëng, t·ª´ m·ªôt lo·∫°i chim s·∫ª ƒë√£ ph√°t tri·ªÉn th√†nh 3 ph√¢n h·ªç kh√°c nhau.

[![H√¨nh 1: V√≠ d·ª• v·ªÅ ch·ªçn l·ªçc t·ª± nhi√™n](Natural_selection.jpg){fig-align="center"}](https://www.biologyonline.com/dictionary/natural-selection)

V·∫≠y l√≠ thuy·∫øt n√†y li√™n quan g√¨ t·ªõi v·∫•n ƒë·ªÅ t·ªëi ∆∞u h√≥a. Th√¥ng th∆∞·ªùng khi b·∫°n mu·ªën t·ªëi ∆∞u h√≥a m·ªôt v·∫•n ƒë·ªÅ g√¨ ƒë√≥, b·∫°n c·∫ßn x√¢y d·ª±ng m√¥ h√¨nh ƒë·ªãnh l∆∞·ª£ng n√≥, v√≠ d·ª• nh∆∞ d∆∞·ªõi ·∫£nh n√†y ta ƒëang c√≥ m√¥ h√¨nh [MILP](https://www.mathworks.com/help/optim/ug/mixed-integer-linear-programming-algorithms.html) nh·∫±m ho·∫°ch ƒë·ªãnh tuy·∫øn ƒë∆∞·ªùng v√† t·ªëi ∆∞u h√≥a qu√£ng ƒë∆∞·ªùng di chuy·ªÉn.

[![H√¨nh 2: M√¥ h√¨nh VRP](MILP.png){fig-align="center"}](https://medium.com/@rihot_gusron/capacitated-vehicle-routing-problem-with-lingo-427c2d3bf724)

M·ª•c ti√™u c·ªßa h√†m ch√≠nh l√† t√¨m ra gi√° tr·ªã nh·ªè nh·∫•t nghƒ©a l√† chi ph√≠ cho vi·ªác di chuy·ªÉn c·ªßa xe l√† nh·ªè nh·∫•t. Do ƒë√≥, b·∫°n c√≥ th·ªÉ h√¨nh dung r·∫±ng **gi√° tr·ªã nh·ªè nh·∫•t** ƒë√≥ nh∆∞ l√† c√°c **c√° th·ªÉ ƒë·ªôt bi·∫øn** c√≥ kh·∫£ nƒÉng s·ªëng s√≥t cao nh·∫•t trong qu·∫©n th·ªÉ.

V√¨ v·∫≠y thu·∫≠t to√°n **Genetic** (GA) ch√≠nh l√† l·∫∑p ƒëi l·∫∑p l·∫°i s·ª± ch·ªçn l·ªçc t·ª± nhi√™n trong m·ªôt qu·∫ßn th·ªÉ ho·∫∑c m·ªôt m·∫´u ƒë·ªÉ ƒë·∫øn cu·ªëi c√πng t√¨m ra c√° th·ªÉ v∆∞·ª£t tr·ªôi nh·∫•t.

## C√°ch ho·∫°t ƒë·ªông GA trong ML:

Trong Machine Learning, GA nh·∫±m t√¨m ra ƒë√∫ng c√°c bi·∫øn c·∫ßn thi·∫øt ƒë·ªÉ x√¢y d·ª±ng m√¥ h√¨nh t·ªët nh·∫•t. G·ªâa s·ª≠ ch√∫ng ta c√≥ 2 m√¥ h√¨nh l√†:

-   M√¥ h√¨nh 1: g·ªìm c√°c bi·∫øn A,C,D.
-   M√¥ h√¨nh 2: g·ªìm bi·∫øn A,B,E.

V·∫≠y m√¥ h√¨nh n√†o m·ªõi l√† t·ªët nh·∫•t cho m√¥ h√¨nh d·ª± ƒëo√°n ? Ch√∫ng ta ch∆∞a bi·∫øt ƒë∆∞·ª£c v√† ch·ªâ c√≥ th·ªÉ so s√°nh n√≥ th√¥ng qua thu·∫≠t to√°n Genetic.

V·ªÅ quy tr√¨nh, thu·∫≠t to√°n Genetic s·∫Ω c√≥ c√°ch ho·∫°t ƒë·ªông nh∆∞ d∆∞·ªõi ƒë√¢y. Quy tr√¨nh n√†y m√¨nh tham kh·∫£o c·ªßa [@rohithgandhi2018].

[![H√¨nh 3: Thu·∫≠t to√°n Genetic](Genetic_Algorithm.png){fig-align="center"}](https://medium.datadriveninvestor.com/genetic-algorithms-9f920939f7cc)

Di·ªÖn gi·∫£i c√°ch ho·∫°t ƒë·ªông:

-   B∆∞·ªõc 1 (**Initialisation**): m·ªói bi·∫øn ƒë∆∞·ª£c xem l√† *Gene* v√† nhi·ªÅu *Gene* g·ªôp l·∫°i th√†nh m·ªôt m√¥ h√¨nh hay g·ªçi l√† *Chromosome* v√† nhi·ªÅu *Chromosome* s·∫Ω t·∫°o th√†nh m·ªôt qu·∫ßn th·ªÉ (*Population*). Vi·ªác n√†y gi·ªëng nh∆∞ l√† b·∫°n ƒëang tr√¨nh b√†y h·∫øt c√°c ph∆∞∆°ng √°n c√≥ th·ªÉ s·ª≠ d·ª•ng.

[![H√¨nh 4: C√°c thu·∫≠t ng·ªØ trong GA](Term.png){fig-align="center"}](https://www.doc.ic.ac.uk/research/technicalreports/2003/DTR03-4.pdf)

-   B∆∞·ªõc 2 (**Fitness Function**): B·∫°n c·∫ßn x√¢y d·ª±ng m·ªôt h√†m m·ª•c ti√™u ƒë·ªÉ t√≠nh to√°n gi√° tr·ªã cho c√°c m√¥ h√¨nh ·ªü b∆∞·ªõc 1.

-   B∆∞·ªõc 3 (**Selection**): Bi·∫øn n√†o c√≥ gi√° tr·ªã y·∫øu k√©m s·∫Ω b·ªã lo·∫°i v√† qu√° tr√¨nh t√≠nh to√°n s·∫Ω ti·∫øp t·ª•c ·ªü th·∫ø h·ªá c·ªßa n√≥ ti·∫øp theo. Di·ªÖn gi·∫£i ƒë∆°n gi·∫£n h∆°n l√† ch√∫ng ta th·ª≠ m·ªôt c√°ch kh√°c v√† c·ªë g·∫Øng c·∫£i thi·ªán k·∫øt qu·∫£.

-   B∆∞·ªõc 4 (**Crossover**): T·∫°o ra m√¥ h√¨nh g·ªìm c√°c bi·∫øn t·ªët ƒë√£ l·ª±a ch·ªçn ·ªü b∆∞·ªõc 3. V√≠ d·ª• nh∆∞ bi·∫øn A, B l√† t·ªët cho m√¥ h√¨nh.

-   B∆∞·ªõc 5 (**Mutation**): Thay ƒë·ªïi m√¥ h√¨nh ƒë·∫ßu v√†o ƒë√£ bao g·ªìm c√°c bi·∫øn ·ªü b∆∞·ªõc 4 v√† b·∫Øt ƒë·∫ßu l·∫°i t·ª´ b∆∞·ªõc 1. V√≠ d·ª• m√¥ h√¨nh c·∫ßn ch·ªçn g·ªìm 5 bi·∫øn v√† ta ƒë√£ ch·ªçn ƒë∆∞·ª£c bi·∫øn A,B l√† t·ªët. Do ƒë√≥, khi quay l·∫°i b∆∞·ªõc 1, ta ch·ªâ c·∫ßn ch·ªçn th√™m 3 bi·∫øn thay v√¨ 5 bi·∫øn nh∆∞ th√¥ng th∆∞·ªùng.

# Th·ª±c h√†nh trong R:

Sau khi ƒë√£ s∆° l∆∞·ª£c v·ªÅ thu·∫≠t to√°n, b√¢y gi·ªù ta s·∫Ω v√†o ph·∫ßn th·ª±c h√†nh trong R. V·∫≠y l√†m sao ƒë·ªÉ ·ª©ng d·ª•ng thu·∫≠t to√°n Genetic trong R, m√¨nh ƒë√£ kham kh·∫£o qua nhi·ªÅu ngu·ªìn t√†i li·ªáu v√† t·ªïng h·ª£p d∆∞·ªõi ƒë√¢y:

**X√¢y d·ª±ng h√†m m·ª•c ti√™u**: h√†m m·ª•c ti√™u l√† b∆∞·ªõc quan tr·ªçng nh·∫•t trong thu·∫≠t to√°n Genetic v√¨ n√≥ l√† c∆° s·ªü ƒë·ªÉ ƒë√°nh gi√° v√† l·ª±a ch·ªçn c√° th·ªÉ v∆∞·ª£t tr·ªôi nh·∫•t. V√† h√†m m·ª•c ti√™u s·∫Ω lu√¥n kh√°c nhau t√πy v√†o v·∫•n ƒë·ªÅ m√† ta ƒë·∫∑t ra. Gi·∫£ s·ª≠ ch√∫ng ta mu·ªën t·ªëi ∆∞u chi ph√≠ th√¨ n√≥ l√† h√†m Min, c√≤n ta mu·ªën t·ªëi ƒëa l·ª£i nhu·∫≠n th√¨ n√≥ s·∫Ω l√† h√†m Max.

V·∫≠y h√†m m·ª•c ti√™u c·ªßa b√†i to√°n tr√™n trong R, b·∫°n c√≥ th·ªÉ tham kh·∫£o ph·∫ßn code b√™n d∆∞·ªõi m√¨nh:

::: callout-important
### Type of fitness function

ƒê·ªëi s·ªë `type` trong h√†m c√≥ 3 gi√° tr·ªã:

-   `"binary"`: ƒë·∫°i di·ªán cho bi·∫øn quy·∫øt ƒë·ªãnh d·∫°ng ph√¢n lo·∫°i, v√≠ d·ª•: c√≥/kh√¥ng
-   `"real-valued"`: d√πng d·ªÉ t·ªëi ∆∞u cho c√°c bi·∫øn quy·∫øt ƒë·ªãnh l√† d·∫°ng s·ªë th·ª±c, s·ªë t·ª± nhi√™n.
-   `"permutation"`: cho c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn vi·ªác s·∫Øp x·∫øp l·∫°i c√°c bi·∫øn th√†nh danh s√°ch, v√≠ d·ª•: thang ƒëo Likert.
:::

Chi ti·∫øt v·ªÅ h√†m `ga()`, b·∫°n c√≥ th·ªÉ tham kh·∫£o t√†i li·ªáu c·ªßa [@lucascrucca2013].

## Thu·∫≠t to√°n Genetic:

V·∫≠y b√¢y gi·ªù ch√∫ng ta s·∫Ω x·ª≠ l√≠ b√†i to√°n tr√™n theo thu·∫≠t to√°n **Genetic**

G·ªâa s·ª≠ ch√∫ng ta c√≥ b√†i to√°n v·ªÅ v·∫≠n chuy·ªÉn h√†ng t·ª´ nh√† kho ƒë·ªÉ th·ªèa m√£n nhu c·∫ßu ·ªü c√°c ƒëi·ªÉm **DC (Distribution center)**. V√† c√¥ng th·ª©c ƒë·ªÉ t√≠nh to√°n ƒë∆∞·ª£c chi ph√≠ l√†:

H√†m chi ph√≠ t·ªïng th·ªÉ ƒë∆∞·ª£c x√°c ƒë·ªãnh nh∆∞ sau:

$$
TC = \sum_{i=1}^{m} \left( D_{ij} \times \frac{P}{F} \times 0.4 + LC_i \right) \times Q_j
$$
V√¨ v·∫≠y, n·∫øu trong c√¥ng vi·ªác, ch√∫ng ta s·∫Ω c·∫ßn l·∫•y d·ªØ li·ªáu t·ª´ **Data warehouse** b·∫±ng SQL ho·∫∑c c√°c ph·∫ßn m·ªÅm **Business Intelligence** kh√°c. ·ªû ƒë√¢y, nh·∫±m minh h·ªça, m√¨nh ƒë√£ t·∫°o ra code ·ªü ph√≠a d∆∞·ªõi ƒë·ªÉ c√°c b·∫°n luy·ªán t·∫≠p.

```{r}
# Create a data frame for loading costs
loading_costs <- data.frame(
  Warehouse = rep(paste("WH", 1:5), each = 4),
  ID = rep(1:5, times = 4),
  Weight_Category = rep(c("< 2 tons", "2 to 5 tons", "5 to 10 tons", "> 10 tons"), times = 5),
  Has_Machine = rep(c("Yes", "No", "Yes", "No", "No"), each = 4),
  Loading_Cost = c(80, 100, 120, 160,  # Warehouse 1 (with machine)
                   110, 150, 180, 210,  # Warehouse 2 (without machine)
                   85, 105, 125, 140,  # Warehouse 3 (with machine)
                   150, 170, 190, 210,  # Warehouse 4 (without machine)
                   140, 165, 185, 215)   # Warehouse 5 (without machine)
)

# Set seed for reproducibility
set.seed(123)

# Define parameters
weight_categories <- c("< 1.5", "1.5 to 2.5", "2.5 to 5", "5 to 10", "> 10")
# Create the data frame
loading_costs <- data.frame(
  Warehouse = rep(1:5, each = 15),  # 5 warehouses, 15 rows each
  DC = rep(rep(1:3, each = 5), times = 5),  # Repeat 1, 2, 3 for each warehouse
  Weight_Category = rep(weight_categories, times = 15),  # Repeat categories for 15 rows
  Loading_Cost = round(runif(75, 5, 150), 2),
  Has_Machine = sample(c("Yes", "No"), 75, replace = TRUE)
)

# Define warehouses with coordinates (latitude, longitude)
warehouses <- data.frame(
  ID = 1:5,
  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060), # Example latitudes (Hanoi, HCMC, Da Nang, etc.)
  Longitude = c(105.804, 108.2022, 106.6957, 108.2772, 105.7460) # Example longitudes
)

# Define distribution centers data in Vietnam (example coordinates)
distribution_centers <- data.frame(
  ID = 1:3,
  Demand = c(90, 30, 150),
  Latitude = c(17.974855, 11.7769, 15.122327), # Example latitudes (Hanoi, Da Nang, HCMC)
  Longitude = c(102.630867, 106.6957, 108.799357) # Example longitudes
)
```

N·∫øu b·∫°n g·∫∑p kh√≥ khƒÉn trong vi·ªác ph·∫£i ƒë·ªëi m·∫∑t v·ªõi c·∫£ ƒë·ªëng d·ªØ li·ªáu t·ª´ h·ªá th·ªëng v√† ch∆∞a bi·∫øt l·∫•y d·ªØ li·ªáu n√†o ƒë·ªÉ ph√¢n t√≠ch ho·∫∑c g·ªôp b·∫£ng n√†o qua b·∫£ng n√†o th√¨ l·ªùi khuy√™n c·ªßa t√¥i l√† h√£y v·∫Ω b·∫£ng **Entity relation diagram (ERD)**. C√°c b·∫°n c√≥ th·ªÉ d·ªÖ d√†ng h√¨nh dung c√°c m·ªëi quan h·ªá th√¥ng qua b·∫£ng **Entity relation diagram (ERD)** d∆∞·ªõi ƒë√¢y:

```{r}
#| echo: false
#| fig-cap: "Bi·ªÉu ƒë·ªì 1: EDR model"
library(datamodelr)
# Create the data model from your data frames
dm1 <- dm_from_data_frames(list(
  Warehouses = warehouses,
  Loading_Costs = loading_costs,
  Distribution_Centers = distribution_centers
)) %>%
  dm_set_key("Warehouses", "ID") %>%
  dm_set_key("Loading_Costs", c("Warehouse", "DC")) %>%
  dm_set_key("Distribution_Centers", "ID") %>%
  dm_add_references(
    Loading_Costs$Warehouse == Warehouses$ID,  # Correct reference
    Loading_Costs$DC == Distribution_Centers$ID  # Assuming this is the correct reference
  )

# Create and render the ERD
dm_create_graph(dm1, rankdir = "LR", columnArrows = TRUE) %>%
  dm_render_graph()
```

**ERD** l√† m·ªôt c√¥ng c·ª• tr·ª±c quan d√πng ƒë·ªÉ m√¥ t·∫£ c·∫•u tr√∫c d·ªØ li·ªáu trong c∆° s·ªü d·ªØ li·ªáu. ERD th·ªÉ hi·ªán c√°c th·ª±c th·ªÉ (*entities*), thu·ªôc t√≠nh (*attributes*), v√† c√°c m·ªëi quan h·ªá (*relationships*) gi·ªØa ch√∫ng. C√°c th·ª±c th·ªÉ th∆∞·ªùng ƒë∆∞·ª£c bi·ªÉu di·ªÖn d∆∞·ªõi d·∫°ng h√¨nh ch·ªØ nh·∫≠t, thu·ªôc t√≠nh d∆∞·ªõi d·∫°ng h√¨nh ellips, v√† m·ªëi quan h·ªá b·∫±ng h√¨nh thoi ho·∫∑c ƒë∆∞·ªùng n·ªëi. ERD gi√∫p l·∫≠p k·∫ø ho·∫°ch cho thi·∫øt k·∫ø c∆° s·ªü d·ªØ li·ªáu, ƒë·∫£m b·∫£o r·∫±ng c√°c y·∫øu t·ªë d·ªØ li·ªáu v√† quan h·ªá gi·ªØa ch√∫ng ƒë∆∞·ª£c x√°c ƒë·ªãnh r√µ r√†ng, t·∫°o n·ªÅn t·∫£ng cho vi·ªác ph√°t tri·ªÉn v√† qu·∫£n l√Ω d·ªØ li·ªáu hi·ªáu qu·∫£.

::: callout-tip
### T·∫£i package datamodelr:

M√¨nh t·∫°o bi·ªÉu ƒë·ªì n√†y b·∫±ng th∆∞ vi·ªán datamodelr. B·∫°n c√≥ th·ªÉ t·∫£i b·∫±ng c√∫ ph√°p: `devtools::install_github("bergant/datamodelr")`
:::

Nh∆∞ v·∫≠y, d·ª±a v√†o ƒë√≥, ta s·∫Ω t√≠nh to√°n ƒë∆∞·ª£c 2 b·∫£ng quan tr·ªçng:

-   B·∫£ng gi√° loading ·ªü c√°c kho. (H√¨nh b√™n tr√°i)

-   B·∫£ng chi ph√≠ v·∫≠n chuy·ªÉn t·ª´ t·ª´ng WH ƒë·∫øn c√°c DCs. (H√¨nh b√™n ph·∫£i)

```{r}
#| warning: false
#| message: false
#| fig-cap: "Bi·ªÉu ƒë·ªì 2: Heatmap cho b·∫£ng chi ph√≠ v·∫≠n chuy·ªÉn v√† b·ªëc x·∫øp "
## Calculate the transportation cost:
# Haversine distance function
haversine <- function(lat1, lon1, lat2, lon2) {
  R <- 6371 # Radius of Earth in kilometers
  dlat <- (lat2 - lat1) * pi / 180
  dlon <- (lon2 - lon1) * pi / 180
  a <- sin(dlat / 2) * sin(dlat / 2) +
       cos(lat1 * pi / 180) * cos(lat2 * pi / 180) * 
       sin(dlon / 2) * sin(dlon / 2)
  c <- 2 * atan2(sqrt(a), sqrt(1 - a))
  R * c # Distance in kilometers
}

# Calculate distance matrix based on coordinates
distance_matrix <- matrix(0, nrow = nrow(warehouses), ncol = nrow(distribution_centers))

for (i in 1:nrow(warehouses)) {
  for (j in 1:nrow(distribution_centers)) {
    distance_matrix[i, j] <- haversine(
      warehouses$Latitude[i], warehouses$Longitude[i],
      distribution_centers$Latitude[j], distribution_centers$Longitude[j]
    )
  }
}

# Define the fuel price (example value)
fuel_price <- 20 # Fuel price per kilometer

# Calculate transportation costs
transportation_costs <- distance_matrix * fuel_price * 0.4

## Calculate the loading cost:
weights_per_good <- 0.1

mean_loading_cost<-loading_costs %>% 
  group_by(DC, Warehouse) %>% 
  summarise(mean = mean(Loading_Cost,na.rm = TRUE)/1000/weights_per_good) %>% # Assumes weighted of goods is 0.1kg 
  ungroup()

library(data.table)
# Reshape the data frame to a wide format
mean_cost_matrix <- dcast(mean_loading_cost,
                          Warehouse ~ DC, 
                          value.var = "mean")

# Convert the data frame to a matrix and remove the Warehouse column
loading_costs_per_dc <- as.matrix(mean_cost_matrix[,-1])

# Set row names as the warehouse names
rownames(loading_costs_per_dc) <- mean_loading_cost$Warehouse[!duplicated(mean_loading_cost$Warehouse)]
```

```{r}
#| warning: false
#| message: false
#| echo: false
#| layout: [[40,60]]
#| fig-caption: "Each cell's color intensity corresponds to the magnitude of the data point it represents, making it easy to identify patterns, trends, and correlations at a glance."
library(ggplot2)
library(reshape2)

# Convert the distance matrix to a data frame
distance_df <- melt(transportation_costs)
colnames(distance_df) <- c("Warehouse", "Distribution_Center", "Transportation Cost (VNƒê)")

# Plot the distance matrix with updated colors
ggplot(distance_df, aes(x = Warehouse, y = Distribution_Center, fill = `Transportation Cost (VNƒê)`)) +
  geom_tile() +
  geom_text(aes(label = round(`Transportation Cost (VNƒê)`, 1)), color = "black") +  # Add numbers
  scale_fill_gradient(high = "#ff7f0e", low = "white") +  # Custom colors
  theme_minimal() +
  labs(title = "Transportation Costs Heatmap",
       x = "Warehouse",
       y = "Distribution Center") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert the transportation costs matrix to a data frame
library(gt)
library(gtExtras)
# Create a gt table
m<-loading_costs %>%
  mutate(Loading_Cost = Loading_Cost * 1000,
         DC = paste("DC",DC),
         Warehouse = paste("WH",Warehouse)) # Convert to currency
  
head(m[order(-m$Loading_Cost),]) %>% 
  gt() %>%
  fmt_currency(
    columns = Loading_Cost,
    currency = "VND",
    decimals = 0,
    use_seps = TRUE
  ) %>%
  tab_header(
    title = md("**Loading Costs by weight category in each warehouses**"),
    subtitle = md("Table just contains **expected loading cost**")
  ) %>%  
  opt_align_table_header(align = "center") %>% 
  cols_label(
    Loading_Cost = "Loading Cost (VNƒê)",
    Weight_Category = "Weight Category",
    Has_Machine = "Has Machine",
    DC = "Distribution Center"
  ) %>% 
  data_color(method = "numeric",
             palette = "viridis",
             reverse = TRUE) %>% 
  gt_theme_pff() %>% 
  tab_style(style = list(cell_text(align = "center")),
            locations = cells_body(columns = everything())) %>%
  tab_style(
    style = list(
      cell_text(align = "center")
    ),
    locations = list(
      cells_column_labels(everything())
    )
  ) %>% 
  tab_source_note(source = md("*Source: package gt in R*")) %>% 
  tab_style(
    style = "font-weight: bold",
    locations = cells_body(Weight_Category)
  )
  
```

Sau khi ƒë√£ c√≥ ƒë·ªß d·ªØ li·ªáu, b·∫°n s·∫Ω b·∫Øt ƒë·∫ßu vi·∫øt h√†m m·ª•c ti√™u v√† d√πng thu·∫≠t to√°n GA ƒë·ªÉ t√¨m ra gi√° tr·ªã t·ªëi ∆∞u nh·∫•t.

Trong h√†m `ga` t·ª´ g√≥i **GA** trong R, c√≥ m·ªôt s·ªë ƒë·ªëi s·ªë quan tr·ªçng cho ph√©p b·∫°n t√πy ch·ªânh thu·∫≠t to√°n di truy·ªÅn. D∆∞·ªõi ƒë√¢y l√† m·ªôt c√°i nh√¨n t·ªïng quan v·ªÅ m·ªôt s·ªë ƒë·ªëi s·ªë quan tr·ªçng:

-   **type**: Ch·ªâ ƒë·ªãnh lo·∫°i t·ªëi ∆∞u h√≥a (v√≠ d·ª•: `"real-valued"`, `"binary"` ho·∫∑c `"permutation"`).

-   **fitness**: H√†m ƒë√°nh gi√° ƒë·ªô ph√π h·ª£p; n√≥ n√™n nh·∫≠n m·ªôt vector tham s·ªë l√†m ƒë·∫ßu v√†o v√† tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã s·ªë.

-   **lower** v√† **upper**: ƒê·ªãnh nghƒ©a gi·ªõi h·∫°n cho c√°c bi·∫øn n·∫øu b·∫°n ƒëang t·ªëi ∆∞u h√≥a trong kh√¥ng gian li√™n t·ª•c (d√πng cho c√°c lo·∫°i gi√° tr·ªã th·ª±c).

-   **popSize**: Thi·∫øt l·∫≠p k√≠ch th∆∞·ªõc qu·∫ßn th·ªÉ cho m·ªói th·∫ø h·ªá.

-   **maxiter**: Ch·ªâ ƒë·ªãnh s·ªë th·∫ø h·ªá t·ªëi ƒëa ƒë·ªÉ ch·∫°y thu·∫≠t to√°n.

-   **run**: Ch·ªâ ƒë·ªãnh s·ªë th·∫ø h·ªá ƒë·ªÉ ch·∫°y thu·∫≠t to√°n m√† kh√¥ng c√≥ s·ª± c·∫£i thi·ªán tr∆∞·ªõc khi d·ª´ng l·∫°i.

-   **pmutation**: X√°c su·∫•t x·∫£y ra ƒë·ªôt bi·∫øn trong qu·∫ßn th·ªÉ.

-   **elitism**: X√°c ƒë·ªãnh xem c√°c c√° th·ªÉ t·ªët nh·∫•t c√≥ n√™n ƒë∆∞·ª£c gi·ªØ l·∫°i trong th·∫ø h·ªá ti·∫øp theo hay kh√¥ng.

Nh·ªØng ƒë·ªëi s·ªë n√†y gi√∫p ƒëi·ªÅu ch·ªânh thu·∫≠t to√°n di truy·ªÅn cho c√°c nhu c·∫ßu t·ªëi ∆∞u h√≥a c·ª• th·ªÉ c·ªßa b·∫°n, cho ph√©p hi·ªáu su·∫•t t·ªët h∆°n v√† h·ªôi t·ª• v·ªÅ c√°c gi·∫£i ph√°p t·ªëi ∆∞u.

Ngo√†i ra, c√≤n c√≥ c√°c l∆∞u √Ω cho b·∫°n khi s·ª≠ d·ª•ng R nh∆∞ sau:

::: callout-caution
### L∆∞u √Ω khi d√πng h√†m ga():

H√†m `ga()` ph·∫£i c√≥ √≠t nh·∫•t 2 ƒë·ªëi s·ªë l√† `type` v√† `fitness th√¨ R m·ªõi ch·∫°y ƒë∆∞·ª£c.`

-   Ri√™ng khi type = "binary" th√¨ c·∫ßn th√™m ƒë·ªëi s·ªë `nBits.`

-   C√≤n khi `type = "real-valued"/"permutation"` th√¨ c·∫ßn th√™m ƒë·ªëi s·ªë `min` v√† `max`.
:::

```{r}
#| message: false
#| warning: false
#| output: false
# Load necessary library
library(GA)
demand<-c(distribution_centers$Demand)

# Define the objective function
objective_function <- function(quantities) {
    quantities_matrix <- matrix(quantities, 
                                nrow = 5, 
                                ncol = 3, 
                                byrow = TRUE)
    
    # Calculate total loading costs
    loading_costs <- rowSums(quantities_matrix) * loading_costs_per_dc  # Total loading costs for each DC
    # Calculate total transportation costs
    transportation_costs <- sum(quantities_matrix * transportation_costs)
    
    # Combine both costs
    total_cost <- sum(loading_costs) + transportation_costs
    
    # Check if demands are met
    if (any(colSums(quantities_matrix) < demand)) {
        return(Inf)  # Penalize if demands are not met
    }
    
    return(total_cost)
}

# Set up the Genetic Algorithm
num_vars <- 5 * 3  # 5 warehouses, 3 distribution centers
ga_result <- ga(
    type = "real-valued",
    fitness = function(x) -objective_function(x),  # Negate for minimization
    lower = rep(0, num_vars),  # Minimum quantity
    upper = rep(100, num_vars),  # Maximum quantity (adjust as needed)
    popSize = 50,
    maxiter = 100,
    run = 10,
    monitor = TRUE
)
```

V√† cu·ªëi c√πng, sau khi c√≥ k·∫øt qu·∫£, m√¨nh s·∫Ω d√πng c√°c th∆∞ vi·ªán g·ªìm: **Leaflet**, **gt**, v√† **bi·ªÉu ƒë·ªì Sankey** ph·ª•c v·ª• nh·ªØng m·ª•c ƒë√≠ch kh√°c nhau cho tr·ª±c quan h√≥a d·ªØ li·ªáu.

1.  **Leaflet**: ƒê√¢y l√† m·ªôt th∆∞ vi·ªán m·∫°nh m·∫Ω ƒë·ªÉ t·∫°o b·∫£n ƒë·ªì t∆∞∆°ng t√°c. N√≥ cho ph√©p ng∆∞·ªùi d√πng d·ªÖ d√†ng th√™m c√°c l·ªõp, ƒëi·ªÉm ƒë√°nh d·∫•u v√† pop-up, r·∫•t l√Ω t∆∞·ªüng ƒë·ªÉ tr·ª±c quan h√≥a d·ªØ li·ªáu ƒë·ªãa l√Ω. Leaflet ƒë·∫∑c bi·ªát h·ªØu √≠ch ƒë·ªÉ hi·ªÉn th·ªã c√°c d·ªØ li·ªáu nh∆∞ v·ªã tr√≠, l·ªô tr√¨nh, ho·∫∑c ph√¢n b·ªë kh√¥ng gian.

2.  **gt**: G√≥i **gt** ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ t·∫°o ra c√°c b·∫£ng ch·∫•t l∆∞·ª£ng cao trong R. N√≥ cho ph√©p ng∆∞·ªùi d√πng ƒë·ªãnh d·∫°ng v√† t·∫°o ki·ªÉu cho b·∫£ng m·ªôt c√°ch d·ªÖ d√†ng, gi√∫p ch√∫ng tr·ªü n√™n h·∫•p d·∫´n v√† d·ªÖ ƒë·ªçc. gt h·ªó tr·ª£ c√°c t√≠nh nƒÉng nh∆∞ ƒë·ªãnh d·∫°ng t√πy ch·ªânh, d√≤ng t√≥m t·∫Øt, v√† th·∫≠m ch√≠ th√™m ch√∫ th√≠ch, n√¢ng cao c√°ch tr√¨nh b√†y d·ªØ li·ªáu trong b√°o c√°o.

3.  **Bi·ªÉu ƒë·ªì Sankey**: Nh·ªØng bi·ªÉu ƒë·ªì n√†y ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ tr·ª±c quan h√≥a lu·ªìng v√† m·ªëi quan h·ªá gi·ªØa c√°c danh m·ª•c kh√°c nhau. Trong R, g√≥i **networkD3** ho·∫∑c **ggalluvial** c√≥ th·ªÉ t·∫°o ra bi·ªÉu ƒë·ªì Sankey, gi√∫p hi·ªÉu c√°ch c√°c gi√° tr·ªã di chuy·ªÉn gi·ªØa c√°c n√∫t, ch·∫≥ng h·∫°n nh∆∞ theo d√µi h√†nh tr√¨nh ng∆∞·ªùi d√πng ho·∫∑c hi·ªÉn th·ªã ph√¢n b·ªï t√†i nguy√™n.

Nh√¨n chung, nh·ªØng c√¥ng c·ª• n√†y cung c·∫•p c√°c l·ª±a ch·ªçn m·∫°nh m·∫Ω ƒë·ªÉ tr√¨nh b√†y d·ªØ li·ªáu m·ªôt c√°ch h·∫•p d·∫´n v√† th√¥ng tin. B·∫°n c√≥ th·ªÉ l·ª±a ch·ªçn 1 trong 3 ch√∫ng, v√¨ l√Ω do h·ªçc n√™n m√¨nh tr√¨nh b√†y c·∫£ 3 lu√¥n!.

```{r}
#| echo: false
#| warning: false
#| message: false
library(leaflet)
# Create custom icons
warehouse_icon <- makeIcon(
      iconUrl = "C:/Users/locca/Documents/Xu√¢n L·ªôc/R/Project R/Genetic-Algorithm/warehouse_icon.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )

dc_icon <- makeIcon(
      iconUrl = "C:/Users/locca/Documents/Xu√¢n L·ªôc/R/Project R/Genetic-Algorithm/distribution_center.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )


## Update flag of countries in each locations:
library(readxl)
write <- read_excel("write.xlsx")
warehouses<-write[1:5,]
distribution_centers<-write[6:8,]
```


```{r}
#| warning: false
#| message: false
#| layout: [[100],[40,60]]
# Assuming ga_result@solution contains optimal quantities
ga_result_solution <- c(ga_result@solution)

# Reshape the solution into a matrix (5 warehouses x 3 DCs)
optimal_quantities <- matrix(ga_result@solution,
                             nrow = 5, 
                             ncol = 3, 
                             byrow = TRUE)

# Convert the matrix to a data frame
weights<-optimal_quantities* weights_per_good

rownames(weights) <- 1:5
colnames(weights) <- 1:3

library(reshape2)
real_weighted <- melt(weights)

# Rename the columns
colnames(real_weighted) <- c("Warehouse", "DC", "Total_Weight")

# Perform left join
result <- real_weighted %>%
  left_join(loading_costs, by = c("Warehouse", "DC"))

result <-result %>% 
  mutate(Price = case_when(
    Total_Weight < 1.5 ~ "< 1.5",
    Total_Weight <2.5 ~ "1.5 to 2.5",
    Total_Weight < 5 ~ "2.5 to 5",
    Total_Weight < 10 ~ "5 to 10",
    Total_Weight >= 10 ~ "> 10",
      is.na(Total_Weight) ~ NA_character_  # Handle NA explicitly if needed
  ))
  
result<-result %>% 
  filter(Weight_Category == Price) %>% 
  select(-Price)

# Join with tranportation cost table:
rownames(transportation_costs) <- 1:5
colnames(transportation_costs) <- 1:3

transport<-melt(transportation_costs)

# Rename the columns
colnames(transport) <- c("Warehouse", "DC", "Transport_cost")


result<-left_join(result,
                  transport,
                  by=c("Warehouse", "DC"))

# Adjust:

result<-result %>% 
      mutate(Loading_Cost = Loading_Cost*1000,
             Transport_cost = Transport_cost*1000,
             DC = paste("DC",DC),
             Warehouse = paste("WH",Warehouse)) 

# Reorder cols in table:
result<-result[,c("Warehouse",
                 "DC",
                 "Has_Machine",
                 "Total_Weight",
                 "Weight_Category",
                 "Loading_Cost",
                 "Transport_cost")]
```

### B√°o c√°o:

Cu·ªëi c√πng l√† hi·ªÉn th·ªã k·∫øt qu·∫£ ƒë√£ ph√¢n t√≠ch ƒë∆∞·ª£c.

ƒê·ªÉ k·∫øt n·ªëi c√°c bi·ªÉu ƒë·ªì l·∫°i v·ªõi nhau, ta th∆∞·ªùng nghƒ© `Shiny` trong **R** nh∆∞ng v√¨ ch√∫ng ta ƒëang t·∫°o website b·∫±ng **Quarto** n√™n output cu·ªëi c√πng s·∫Ω l√† m·ªôt trang web tƒ©nh - *static website*. Do ƒë√≥, n√≥ s·∫Ω kh√¥ng ph·∫£n h·ªìi v·ªõi th√¥ng tin ƒë·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng ho·∫∑c ch·∫°y b·∫•t k·ª≥ m√£ R n√†o. B·∫°n c√≥ th·ªÉ h√¨nh dung gi·ªëng nh∆∞ b·∫°n ƒëang mu·ªën xem bi·ªÉu ƒë·ªì v·ªÅ doanh thu trong th√°ng ti·∫øp theo tr√™n 1 bi·ªÉu ƒë·ªì trong Word - kh√¥ng th·ªÉ l√†m ƒë∆∞·ª£c v√¨ n√≥ thu·ªôc d·∫°ng vƒÉn b·∫£n, b·∫°n ch·ªâ ƒë·ªçc ho·∫∑c nh√¨n ch·ª© kh√¥ng t∆∞∆°ng t√°c ƒë∆∞·ª£c.

Tuy v·∫≠y, sau m·ªôt th·ªùi gian t√¨m hi·ªÉu, m√¨nh c≈©ng t√¨m ƒë∆∞·ª£c c√°ch ƒë·ªÉ nh√∫ng **Shiny** v√†o R ƒë·ªÉ hi·ªÉn th·ªã tr√™n Quarto. Ngu·ªìn t√†i li·ªáu b·∫°n c√≥ th·ªÉ kham kh·∫£o ·ªü trang n√†y [r-shinylive-demo](https://github.com/coatless-quarto/r-shinylive-demo).

T√≥m t·∫Øt cho b·∫°n n√†o l∆∞·ªùi ƒë·ªçc th√¨ b·∫°n c·∫ßn ƒë·ªïi chunk t·ª´ `{r}` th√†nh `shinylive-r` v√† th√™m c√°c tham s·ªë nh∆∞ d∆∞·ªõi ƒë√¢y.

````yml
```{shinylive-r}
#| standalone: true
#| viewHeight: 1000
```
````

```{shinylive-r}
#| viewerHeight: 1000
#| standalone: true

## Prepare data:

# Convert GA solution to a matrix
# Optimal quantities matrix
optimal_quantities <- matrix(c(
  43.306058, 10.87137, 13.26283,
  15.524054, 30.42748, 48.86716,
  7.599769, 44.93531, 27.46289,
  18.556927, 17.60396, 41.85203,
  16.305016, 13.15498, 21.79634
), nrow = 5, ncol = 3, byrow = TRUE)


# Warehouse data:
warehouses <- data.frame(
  ID = 1:5,
  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060),
  Longitude = c(105.8040, 108.2022, 106.6957, 108.2772, 105.7460),
  District = c("ƒê·ªëng ƒêa", "H·∫£i Ch√¢u", "Qu·∫≠n 1", "Mang Yang", "ƒê√¥ng S∆°n"),
  Province = c("H√† N·ªôi", "ƒê√† N·∫µng", "H·ªì Ch√≠ Minh", "Gia Lai", "Thanh H√≥a"),
  Address = c(
    "2RH3+9HX ƒê·ªëng ƒêa, H√† N·ªôi, Vi·ªát Nam",
    "3632+RV4 H·∫£i Ch√¢u, ƒê√† N·∫µng, Vi·ªát Nam",
    "QMGW+Q74 Qu·∫≠n 1, H·ªì Ch√≠ Minh, Vi·ªát Nam",
    "375G+8VG Mang Yang, Gia Lai, Vi·ªát Nam",
    "RP4W+99X ƒê√¥ng S∆°n, Thanh H√≥a, Vi·ªát Nam"
  )
)

# Distribution center data:
distribution_centers <- data.frame(
  ID = 1:3,
  Latitude = c(17.97486, 11.77690, 15.12233),
  Longitude = c(102.6309, 106.6957, 108.7994),
  District = c("Vi√™ng ChƒÉn", "L·ªôc Ninh", "Qu·∫£ng Ng√£i"),
  Province = c("L√†o", "B√¨nh Ph∆∞·ªõc", "Qu·∫£ng Ng√£i"),
  Address = c(
    "XJFJ+W8X Vi√™ng ChƒÉn, L√†o",
    "QMGW+Q74 L·ªôc Ninh, B√¨nh Ph∆∞·ªõc, Vi·ªát Nam",
    "4QCX+WPQ Qu·∫£ng Ng√£i, Vi·ªát Nam"
  )
)

# Custom icon:
warehouse_icon <- makeIcon(
      iconUrl = "C:/Users/locca/Documents/Xu√¢n L·ªôc/R/Project R/Genetic-Algorithm/warehouse_icon.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )

dc_icon <- makeIcon(
      iconUrl = "C:/Users/locca/Documents/Xu√¢n L·ªôc/R/Project R/Genetic-Algorithm/distribution_center.png",  # Update with your actual file path
      iconWidth = 30, 
      iconHeight = 30
    )

# Load required libraries
pacman::p_load(leaflet, 
               dplyr, 
               networkD3)
library(shiny)
library(bslib)

# Define UI
ui <- fluidPage(
  titlePanel("Warehouse Distribution Dashboard"),
  
  sidebarLayout(
    sidebarPanel(
      checkboxGroupInput(inputId = "warehouse", 
                         label = "Select Warehouse:", 
                         choices = paste("Warehouse", 1:5), 
                         selected = paste("Warehouse", 1))
    ), 
    mainPanel(
      tabsetPanel(
        tabPanel("Map", 
                 leafletOutput("map", height = "400px")),
        tabPanel("Data & Sankey",
                 fluidRow(
                   column(8, dataTableOutput("cost_table")),
                   column(4, uiOutput("sankey_ui"))
                 )
        )
      )
    )
  )
)

# Define server logic
server <- function(input, output, session) {
  
  location <- reactive({
    req(input$warehouse) 
    as.numeric(sub("Warehouse ", "", input$warehouse))
  })
  
  # Create the leaflet map
  output$map <- renderLeaflet({
    req(location())
    
    # Initialize the map
    map <- leaflet() %>%
      addTiles() %>%
      addProviderTiles(providers$CartoDB.Positron) %>%
      addMarkers(data = warehouses %>% filter(ID %in% location()), 
                 lat = ~Latitude, 
                 lng = ~Longitude, 
                 label = ~paste0("<strong> ID Warehouse: </strong> ", ID, "<br/> ",
                                 "<strong> Province: </strong> ", Province, "<br/> ",
                                 "<strong> District: </strong> ", District, "<br/> ",
                                 "<strong> Address: </strong> ", Address, "<br/> ") %>% 
                   lapply(htmltools::HTML),
                 icon = warehouse_icon) %>%
      addMarkers(data = distribution_centers, 
                 lat = ~Latitude, 
                 lng = ~Longitude, 
                 label = ~paste0("<strong> ID Distribution Center: </strong> ", ID, "<br/> ",
                                 "<strong> Province: </strong> ", Province, "<br/> ",
                                 "<strong> District: </strong> ", District, "<br/> ",
                                 "<strong> Address: </strong> ", Address, "<br/> ") %>% 
                   lapply(htmltools::HTML),
                 icon = dc_icon)
    
    qty_data <- optimal_quantities[location(), , drop = FALSE]  
    
    # Add routes based on the optimal quantities
    for (i in 1:nrow(qty_data)) {
      for (j in 1:ncol(qty_data)) {
        if (qty_data[i, j] > 0) {
          route_start <- warehouses[warehouses$ID == i, c("Longitude", "Latitude")]
          route_end <- distribution_centers[distribution_centers$ID == j, c("Longitude", "Latitude")]
          
          map <- map %>%
            addPolylines(lat = c(route_start$Latitude, route_end$Latitude),
                         lng = c(route_start$Longitude, route_end$Longitude),
                         color = "black", weight = 2, opacity = 0.5)
        }
      }
    }
    
    map  # Return the modified map
  })
  
  # Render the cost table
  output$cost_table <- renderDataTable({
    req(location())
    
    gt <- result %>% 
      filter(Warehouse %in% paste("WH", location())) %>% 
      select(c(Warehouse, DC, Loading_Cost, Transport_cost))
    
    gt
  })
  
  # Render the Sankey diagram
  output$sankey_ui <- renderUI({
    req(location())
    
    qty_data <- optimal_quantities[location(), , drop = FALSE] 
    req(nrow(qty_data) > 0)  # Ensure there is data to display
    
    # Create links data frame
    links <- data.frame(
      source = rep(0:(nrow(qty_data) - 1), each = ncol(qty_data)),  
      target = as.vector(sapply(0:(ncol(qty_data) - 1), 
                                function(j) rep(nrow(qty_data) + j, nrow(qty_data)))),
      value = as.vector(qty_data)  
    )
    
    # Filter for selected warehouses
    links <- links %>% filter(source %in% (location() - 1))  
    
    # Create nodes data frame
    nodes <- data.frame(name = c(paste("Warehouse", location()), paste("DC", 1:ncol(qty_data))))
    
    # Create the Sankey network
    sankey <- sankeyNetwork(Links = links, 
                            Nodes = nodes, 
                            Source = "source", 
                            Target = "target", 
                            Value = "value",
                            NodeID = "name",
                        height = 500,  
                        width = 400,
                        fontSize = 12,
                        nodeWidth = 20,
                        sinksRight = FALSE) # Change this value to make it thinner
    
    # Customize tooltips and add click functionality to show a value panel
sankey <- htmlwidgets::onRender(sankey, "
  function(el, x) {
    // Create a div for the value panel
    var valuePanel = d3.select('body').append('div')
      .attr('class', 'value-panel')
      .style('position', 'absolute')
      .style('padding', '8px')
      .style('background', 'lightgray')
      .style('border', '1px solid gray')
      .style('border-radius', '4px')
      .style('opacity', 0);  // Start hidden

    // Append title for tooltips on hover
    d3.selectAll('.link')
      .append('title')
      .text(function(d) { return d.value; });  // Show value on hover

    // Add click event to show the value panel
    d3.selectAll('.link')
      .on('click', function(event, d) {
        // Ensure we get the correct value
        var value = d3.select(this).datum().value;

        // Position the value panel near the mouse cursor
        valuePanel
          .style('left', (event.pageX + 5) + 'px')
          .style('top', (event.pageY + 5) + 'px')
          .style('opacity', 1)  // Make it visible
          .html('Value: ' + value);  // Set the text to the link value

        // Hide the panel after a delay
        setTimeout(function() {
          valuePanel.style('opacity', 0);
        }, 2000);  // Change the delay as needed
      });
  }
")
    
    ## Add title and caption:
sankey <- htmlwidgets::appendContent(sankey, htmltools::tags$p(style = "font-size: 12px; text-align: right;", " A wider arrow indicates that a larger quantity is being sent from that warehouse to a distribution center."))
    sankey  # Output the Sankey diagram
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

B·∫°n c√≥ th·ªÉ th·∫•y v·ªõi **dashboard** nh∆∞ v·∫≠y, ta c√≥ th·ªÉ xem ƒë∆∞·ª£c nhi·ªÅu th√¥ng tin h∆°n nh∆∞:

- V·ªã tr√≠ c·ª• th·ªÉ c·ªßa t·ª´ng *WH* v√† *DC* c≈©ng nh∆∞ l√† c√°c tuy·∫øn ƒë∆∞·ªùng d·ª± ki·∫øn b·∫±ng c√°c ƒë∆∞·ªùng th·∫≥ng minh h·ªça. (Xem **Map tab**)

- Th√¥ng tin v·ªÅ chi ph√≠ *Loading cost* v√† *Transporation cost* c≈©ng nh∆∞ l∆∞·ª£ng h√†ng c·∫ßn v·∫≠n chuy·ªÉn cho t·ª´ng nh√† kho. (Xem **Table and Sankey tab**)

B·∫°n c√≥ th·ªÉ xem cho 1 ho·∫∑c nhi·ªÅu nh√† kho b·∫±ng c√°ch *click* tr√™n thanh **Filter**. Ngo√†i ra, ƒë·∫∑c bi·ªát v·ªõi **Sankey chart**, b·∫°n c·∫ßn gi·ªØ ho·∫∑c *click* chu·ªôt v√†o tuy·∫øn ƒë·ªÉ xem ƒë∆∞·ª£c s·ªë l∆∞·ª£ng h√†ng.

Tuy r·∫•t th√≠ch R nh∆∞ng m√¨nh v·∫´n kh√¥ng th√≠ch x√¢y d·ª±ng dashboard b·∫±ng R l·∫Øm v√¨ qu√° n·∫∑ng v·ªÅ code v√† kh√¥ng hi·ªáu qu·∫£ v·ªÅ th·ªùi gian, ngu·ªìn l·ª±c. C√°c tools kh√°c m√¨nh ∆∞u ti√™n h∆°n nh∆∞ **Power BI**, **Tableau** ho·∫∑c c√°c **BIs** m√† c√¥ng ty b·∫°n s·ª≠ d·ª•ng trong c√¥ng vi·ªác h·∫±ng ng√†y.

## M√¥ h√¨nh MILP:

### Gi·ªõi thi·ªáu s∆° l∆∞·ª£c:

**MILP (Mixed Integer Linear Programming)** l√† m·ªôt ph∆∞∆°ng ph√°p t·ªëi ∆∞u h√≥a ƒë∆∞·ª£c s·ª≠ d·ª•ng trong c√°c b√†i to√°n l·∫≠p k·∫ø ho·∫°ch, ph√¢n b·ªï t√†i nguy√™n, v√† quy·∫øt ƒë·ªãnh trong c√°c lƒ©nh v·ª±c nh∆∞ logistics, s·∫£n xu·∫•t, t√†i ch√≠nh, v√† nhi·ªÅu lƒ©nh v·ª±c kh√°c. MILP l√† m·ªôt ph·∫ßn m·ªü r·ªông c·ªßa l·∫≠p tr√¨nh tuy·∫øn t√≠nh (Linear Programming - LP), trong ƒë√≥ c√≥ c√°c bi·∫øn l√† s·ªë nguy√™n (integer variables) b√™n c·∫°nh c√°c bi·∫øn li√™n t·ª•c (continuous variables).

Trong ƒë√≥, c·∫•u tr√∫c c·ªßa m·ªôt b√†i to√°n MILP bao g·ªìm:

1.  **H√†m m·ª•c ti√™u**: L√† m·ªôt h√†m tuy·∫øn t√≠nh m√† b·∫°n mu·ªën t·ªëi ∆∞u h√≥a (t·ªëi ƒëa h√≥a ho·∫∑c t·ªëi thi·ªÉu h√≥a).

    $$
    \text{Maximize or Minimize } Z = c_1x_1 + c_2x_2 + \ldots + c_nx_n
    $$

2.  **R√†ng bu·ªôc**: Bao g·ªìm c√°c ƒëi·ªÅu ki·ªán tuy·∫øn t√≠nh m√† c√°c bi·∫øn ph·∫£i th·ªèa m√£n.

    $$
    a_{11}x_1 + a_{12}x_2 + \ldots + a_{1n}x_n \leq b_1
    $$

    $$
    a_{21}x_1 + a_{22}x_2 + \ldots + a_{2n}x_n \leq b_2
    $$

    ... v√† nhi·ªÅu r√†ng bu·ªôc kh√°c.

3.  **Bi·∫øn quy·∫øt ƒë·ªãnh**: C√°c bi·∫øn trong b√†i to√°n c√≥ th·ªÉ l√†:

    -   Bi·∫øn li√™n t·ª•c: C√≥ th·ªÉ nh·∫≠n m·ªçi gi√° tr·ªã th·ª±c (v√≠ d·ª•: s·ªë l∆∞·ª£ng s·∫£n ph·∫©m).
    -   Bi·∫øn nguy√™n: Ch·ªâ nh·∫≠n gi√° tr·ªã nguy√™n (v√≠ d·ª•: s·ªë l∆∞·ª£ng xe t·∫£i).
    -   Bi·∫øn nh·ªã ph√¢n: Ch·ªâ nh·∫≠n gi√° tr·ªã 0 ho·∫∑c 1 (v√≠ d·ª•: c√≥ ho·∫∑c kh√¥ng s·ª≠ d·ª•ng m·ªôt nh√† m√°y).

**·ª®ng d·ª•ng c·ªßa MILP**

-   **Qu·∫£n l√Ω chu·ªói cung ·ª©ng**: T·ªëi ∆∞u h√≥a vi·ªác ph√¢n ph·ªëi h√†ng h√≥a t·ª´ c√°c kho ƒë·∫øn c√°c kh√°ch h√†ng.
-   **L·∫≠p k·∫ø ho·∫°ch s·∫£n xu·∫•t**: X√°c ƒë·ªãnh s·ªë l∆∞·ª£ng s·∫£n ph·∫©m c·∫ßn s·∫£n xu·∫•t ƒë·ªÉ t·ªëi ƒëa h√≥a l·ª£i nhu·∫≠n ho·∫∑c gi·∫£m chi ph√≠.
-   **T·ªëi ∆∞u h√≥a l·ªãch tr√¨nh**: L·∫≠p l·ªãch cho nh√¢n vi√™n, m√°y m√≥c, ho·∫∑c t√†i nguy√™n ƒë·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t.
-   **Quy ho·∫°ch ƒë√¥ th·ªã**: T·ªëi ∆∞u h√≥a vi·ªác s·ª≠ d·ª•ng ƒë·∫•t v√† t√†i nguy√™n trong quy ho·∫°ch th√†nh ph·ªë.

Trong R c√≥ c√°c th∆∞ vi·ªán nh∆∞ `lpSolve`, `ompr`, v√† `ROI` c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ gi·∫£i quy·∫øt c√°c b√†i to√°n MILP.

### V√≠ d·ª•:

MILP l√† m·ªôt c√¥ng c·ª• m·∫°nh m·∫Ω cho vi·ªác t·ªëi ∆∞u h√≥a trong nhi·ªÅu lƒ©nh v·ª±c kh√°c nhau. V·ªõi kh·∫£ nƒÉng k·∫øt h·ª£p gi·ªØa c√°c bi·∫øn li√™n t·ª•c v√† s·ªë nguy√™n, MILP c√≥ th·ªÉ gi·∫£i quy·∫øt nhi·ªÅu b√†i to√°n ph·ª©c t·∫°p m√† c√°c ph∆∞∆°ng ph√°p t·ªëi ∆∞u h√≥a kh√°c kh√¥ng th·ªÉ th·ª±c hi·ªán hi·ªáu qu·∫£.

G·ªâa s·ª≠ ta c√≥ b√†i to√°n v·ªÅ v·∫•n ƒë·ªÅ **Transshipment** c√≥ y√™u c·∫ßu l√† t√¨m ra ph∆∞∆°ng √°n v·∫≠n t·∫£i t·ªëi ∆∞u nh·∫•t ƒë·ªÉ v·∫≠n chuy·ªÉn h√†ng h√≥a t·ª´ nh√† m√°y (**Factory**) th√¥ng qua **Crossdocking** v√† ƒë·∫øn ƒë∆∞·ª£c **Distribution Center** v·ªõi m·ª•c ti√™u l√† ƒë·∫°t **chi ph√≠ th·∫•p nh·∫•t**.

![H√¨nh 5: V·∫•n ƒë·ªÅ Transshipment](transshipment.png){fig-align="center"}

V√¨ b√†i to√°n n√†y thu·ªôc d·∫°ng tuy·∫øn t√≠nh, ph∆∞∆°ng ph√°p MILP s·∫Ω l√†m t·ªët h∆°n nhi·ªÅu so v·ªõi thu·∫≠t to√°n GA b√™n tr√™n.

```{r}
#| warning: false
#| message: false
#| output: false
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)
#Input:
Supply <-c(200,300,100,150,220)
Demand <-c(150,100,110,200,180)
DC<-2
m<-length(Supply)
n<-length(Demand)

Cost_CD<-read.table(text = 
                    "CD1 CD2
                     30 50
                     23 66
                     35 14
                     70 12
                     65 70",header = T)
Cost_DC<-read.table(text = 
                      "DC1 DC2 DC3 DC4 DC5
                       12 25 22 40 41
                       65 22 23 12 15",header = T)

#MILP model from the 
model5 <- MIPModel() %>%
  # Add variable
  add_variable(x[i, j], i = 1:m, j = 1:DC) %>%
  add_variable(y[j, k], j = 1:DC, k = 1:n) %>%
  # minimize the cost of transshipment:
  set_objective(sum_expr(x[i, j]*Cost_CD[i, j],i = 1:m, j = 1:DC)+ sum_expr(y[j, k]*Cost_DC[j, k], k = 1:n, j = 1:DC),"min") %>%
  add_constraint(sum_expr(y[j, k], j = 1:DC) >= Demand[k], k = 1:n) %>%
  # The amount of inventory in Crossdocking is smaller than production goods
  add_constraint(sum_expr(x[i, j], j = 1:DC) <= Supply[i], i = 1:m) %>% 
  # The amount of is bigger than demand in DC
  add_constraint(sum_expr(x[i, j], i = 1:m) - sum_expr(y[j, k], k = 1:n) >= 0,j = 1:DC) %>%
  add_constraint(x[i, j] >= 0, j = 1:DC, i = 1:m)%>% 
  add_constraint(y[j, k] >= 0, j = 1:DC, k = 1:n)%>% 
  #Solve the model:
  solve_model(with_ROI(solver = "glpk", verbose = TRUE))
```

```{r}
#| layout-nrow: 2
#| warning: false
#| message: false
#| echo: false


## Table:
solution <- get_solution(model5, x[i, j]) %>% 
     filter(value > 0)

library(gt)
library(dplyr)
library(scales)  

# Assuming `solution` contains the results of x[i, j]
# Transform the solution into a tidy format for the table
table_data <- solution %>%
  rename(Manufacturer = i, DC = j, Flow = value) %>%
  mutate(Manufacturer = paste("Manufacturer", Manufacturer),
         DC = paste("DC", DC)) %>% 
  select(-variable)

# Create a gt table
table_data %>%
  gt() %>%
  tab_header(
    title = md("**Transshipment flows from Manufacturers to Distribution Centers**")
  ) %>%
  cols_label(
    Manufacturer = md("**Manufacturer**"),
    DC = md("**Distribution Center**"),
    Flow = md("**Flow Amount**")) %>%
  fmt_number(
    columns = c(Flow),
    decimals = 2
  ) %>%
  data_color(
    columns = c(Flow),  # Use c() instead of vars()
    colors = scales::col_numeric(palette = c("#2ca02c","#ff7f0e"), domain = NULL)
  ) %>%
  cols_align(
    align = "center",
    columns = everything()  # Applies to all columns
  ) %>%
  tab_options(
    table.width = pct(100)
  ) %>% 
  gt_theme_espn()

## Barchart:

library(ggplot2)
plot_data <- solution %>%
  rename(Manufacter= i, DC = j, Flow = value) %>%
  mutate(Manufacter = paste("Manufacter", Manufacter),
         DC = paste("DC", DC))

# Create a plot
ggplot(plot_data, aes(x = Manufacter, y = Flow, fill = DC)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "",
       x = "Manufacters",
       y = "Flow Amount",
       fill = "Distribution Centers") +
  theme(text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")
```


Nh∆∞ v·∫≠y, ch√∫ng ta ƒë√£ ƒë∆∞·ª£c bi·∫øt s∆° l∆∞·ª£c v·ªÅ thu·∫≠t to√°n Genetic v√† m√¥ h√¨nh MILP c≈©ng nh∆∞ c√°ch th·ª±c hi·ªán trong Rstudio. 

N·∫øu b·∫°n c√≥ c√¢u h·ªèi hay th·∫Øc m·∫Øc n√†o, ƒë·ª´ng ng·∫ßn ng·∫°i li√™n h·ªá v·ªõi m√¨nh qua Gmail. B√™n c·∫°nh ƒë√≥, n·∫øu b·∫°n mu·ªën xem l·∫°i c√°c b√†i vi·∫øt tr∆∞·ªõc ƒë√¢y c·ªßa m√¨nh, h√£y nh·∫•n v√†o hai n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ truy c·∫≠p trang **Rpubs** ho·∫∑c m√£ ngu·ªìn tr√™n **Github**. R·∫•t vui ƒë∆∞·ª£c ƒë·ªìng h√†nh c√πng b·∫°n, h·∫πn g·∫∑p l·∫°i! üòÑüòÑüòÑ


```{=html}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Me</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg">
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; }
        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }
        label { display: block; margin: 10px 0 5px; }
        input[type="email"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }
        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }
        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }
        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }
        .rpubs-button button { background-color: #75AADB; }
        .rpubs-button button:hover { background-color: #5A9BC2; }
        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }
        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Contact Me</h2>
        <form id="emailForm">
            <label for="email">Your Email:</label>
            <input type="email" id="email" name="email" required aria-label="Email Address">
            <div class="error-message" id="error-message" style="display: none;">Please enter a valid email address.</div>
            <button type="submit">Send Email</button>
        </form>
        <div class="github-button">
            <button>
                <a href="https://github.com/Loccx78vn" target="_blank" style="color: white; text-decoration: none;">
                    <i class="fab fa-github"></i> View Code on GitHub
                </a>
            </button>
        </div>
        <div class="rpubs-button">
            <button>
                <a href="https://rpubs.com/loccx" target="_blank" style="color: white; text-decoration: none;">
                    <img src="https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg" alt="RStudio icon" class="rpubs-icon"> Visit my RPubs
                </a>
            </button>
        </div>
    </div>

    <script>
        document.getElementById('emailForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            const emailInput = document.getElementById('email');
            const email = emailInput.value;
            const errorMessage = document.getElementById('error-message');

            // Simple email validation regex
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (emailPattern.test(email)) {
                errorMessage.style.display = 'none'; // Hide error message
                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;
                window.open(gmailLink, '_blank'); // Open in new tab
            } else {
                errorMessage.style.display = 'block'; // Show error message
            }
        });
    </script>
</body>
</html>
```
